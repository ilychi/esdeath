name: Sync Rules Sources

on:
  workflow_dispatch:
  schedule:
    # æ¯æ—¥12:00æ‰§è¡Œï¼Œä¸ä¸»æ„å»ºæµç¨‹åŒæ­¥
    - cron: '0 12 * * *'

# å¹¶å‘æ§åˆ¶ï¼Œé¿å…é‡å¤åŒæ­¥
concurrency:
  group: sync-workflow
  cancel-in-progress: false
  
jobs:
  sync_rules:
    name: ğŸ”„ åŒæ­¥è§„åˆ™æº
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ” æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        persist-credentials: true
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: âš™ï¸ è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: npm install
        
    - name: ğŸ”„ æ‰§è¡ŒåŒæ­¥è„šæœ¬
      run: npm run sync
      env:
        TZ: 'Asia/Shanghai'
        
    - name: ğŸ’¾ æäº¤æ›´æ”¹
      run: |
        if [[ -n $(git status -s) ]]; then
          git config --local user.email "rin.tohsaka@fate-stay-night.com"
          git config --local user.name "Rin Tohsaka"
          git add .
          git commit -m "ğŸ”„ è‡ªåŠ¨åŒæ­¥è§„åˆ™æº - $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M')"
          
          # å®‰å…¨æ¨é€ï¼šå¤„ç†å¯èƒ½çš„è¿œç¨‹æ›´æ”¹
          max_retries=3
          retry_count=0
          while [ $retry_count -lt $max_retries ]; do
            if git push; then
              echo "âœ… æ¨é€æˆåŠŸ"
              break
            else
              echo "âŒ æ¨é€å¤±è´¥ï¼Œå°è¯•åŒæ­¥è¿œç¨‹æ›´æ”¹... (å°è¯• $((retry_count + 1))/$max_retries)"
              git pull --rebase || {
                echo "Rebaseå¤±è´¥ï¼Œä½¿ç”¨mergeç­–ç•¥"
                git pull --no-rebase
              }
              retry_count=$((retry_count + 1))
              if [ $retry_count -eq $max_retries ]; then
                echo "ğŸ’¥ è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œæ¨é€å¤±è´¥"
                exit 1
              fi
            fi
          done
          
          echo "ğŸ“Š åŒæ­¥ç»Ÿè®¡:" >> $GITHUB_STEP_SUMMARY
          echo "- **åŒæ­¥æ—¶é—´**: $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "- **æ›´æ–°æ–‡ä»¶**: $(git diff HEAD~1 --name-only | wc -l) ä¸ª" >> $GITHUB_STEP_SUMMARY
        else
          echo "ğŸ“ æ²¡æœ‰è§„åˆ™æºæ›´æ–°"
          echo "ğŸ“Š åŒæ­¥ç»“æœ: æ— æ›´æ–°" >> $GITHUB_STEP_SUMMARY
        fi

    # æˆåŠŸåè§¦å‘ä¸»æ„å»ºæµç¨‹ï¼ˆ30åˆ†é’Ÿåè‡ªåŠ¨æ‰§è¡Œï¼‰
    - name: ğŸš€ è§¦å‘ä¸»æ„å»ºæµç¨‹
      if: success()
      uses: peter-evans/repository-dispatch@v2
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        event-type: trigger-main-build
