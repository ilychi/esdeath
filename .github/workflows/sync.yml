name: Sync Rules Sources

on:
  workflow_dispatch:
  schedule:
    # 每日12:00执行，与主构建流程同步
    - cron: '0 12 * * *'

# 并发控制，避免重复同步
concurrency:
  group: sync-workflow
  cancel-in-progress: false
  
jobs:
  sync_rules:
    name: 🔄 同步规则源
    runs-on: ubuntu-latest
    
    steps:
    - name: 🔍 检出代码
      uses: actions/checkout@v4
      with:
        persist-credentials: true
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ⚙️ 设置 Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: 📦 安装依赖
      run: npm install
        
    - name: 🔄 执行同步脚本
      run: npm run sync
      env:
        TZ: 'Asia/Shanghai'
        
    - name: 💾 提交更改
      run: |
        if [[ -n $(git status -s) ]]; then
          git config --local user.email "rin.tohsaka@fate-stay-night.com"
          git config --local user.name "Rin Tohsaka"
          git add .
          git commit -m "🔄 自动同步规则源 - $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M')"
          
          # 安全推送：处理可能的远程更改
          max_retries=3
          retry_count=0
          while [ $retry_count -lt $max_retries ]; do
            if git push; then
              echo "✅ 推送成功"
              break
            else
              echo "❌ 推送失败，尝试同步远程更改... (尝试 $((retry_count + 1))/$max_retries)"
              git pull --rebase || {
                echo "Rebase失败，使用merge策略"
                git pull --no-rebase
              }
              retry_count=$((retry_count + 1))
              if [ $retry_count -eq $max_retries ]; then
                echo "💥 达到最大重试次数，推送失败"
                exit 1
              fi
            fi
          done
          
          echo "📊 同步统计:" >> $GITHUB_STEP_SUMMARY
          echo "- **同步时间**: $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "- **更新文件**: $(git diff HEAD~1 --name-only | wc -l) 个" >> $GITHUB_STEP_SUMMARY
        else
          echo "📝 没有规则源更新"
          echo "📊 同步结果: 无更新" >> $GITHUB_STEP_SUMMARY
        fi

    # 成功后触发主构建流程（30分钟后自动执行）
    - name: 🚀 触发主构建流程
      if: success()
      uses: peter-evans/repository-dispatch@v2
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        event-type: trigger-main-build
