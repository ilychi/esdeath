name: Loon to Surge Module Conversion

on:
  repository_dispatch:
    types: [trigger-convert]
  workflow_dispatch:

# å¹¶å‘æ§åˆ¶ï¼Œé¿å…é‡å¤è½¬æ¢
concurrency:
  group: convert-workflow
  cancel-in-progress: false  # ä¸å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    services:
      docker:
        image: xream/script-hub:latest
        ports:
          - 9100:9100
          - 9101:9101
    steps:
      # æ·»åŠ ç­‰å¾…æ£€æŸ¥ï¼Œç¡®ä¿å‰åºå·¥ä½œæµå®Œæˆ
      - name: Wait for prerequisites
        run: |
          echo "Starting conversion workflow..."
          sleep 5  # ç»™äºˆçŸ­æš‚å»¶è¿Ÿç¡®ä¿èµ„æºå°±ç»ª
          
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq netcat-openbsd

      - name: Wait for Docker service to be ready
        run: |
          echo "Waiting for Docker service to be ready..."
          for i in {1..10}; do
            nc -z localhost 9101 && break
            sleep 10
          done

      - name: Download README.md
        run: |
          curl -s -o README.md https://raw.githubusercontent.com/luestr/ProxyResource/main/README.md

      - name: Extract .plugin URLs
        run: |
          echo "Extracting plugin URLs from README.md..."
          # æå–æ‰€æœ‰åŒ…å« plugin= å‚æ•°çš„é“¾æ¥
          grep -oP 'https://www\.nsloon\.com/openloon/import\?plugin=[^"]+' README.md > nsloon_urls.txt
          
          # ä»æ¯ä¸ªé“¾æ¥ä¸­æå–å®é™…çš„æ’ä»¶URL
          > plugin_urls.txt
          while IFS= read -r line; do
            # æå– plugin= å‚æ•°çš„å€¼
            plugin_url=$(echo "$line" | grep -oP '(?<=plugin=)[^"]+')
            if [[ -n "$plugin_url" ]]; then
              echo "$plugin_url" >> plugin_urls.txt
              echo "Extracted: $plugin_url"
            fi
          done < nsloon_urls.txt

          # Add fmz200's blockAds plugin with custom name
          echo "https://raw.githubusercontent.com/fmz200/wool_scripts/main/Loon/plugin/blockAds.plugin?rename=Remove_ads_by_fmz" >> plugin_urls.txt
          echo "Added fmz200 plugin to list"
          
          # ç»Ÿè®¡æå–çš„æ’ä»¶æ•°é‡
          total_count=$(wc -l < plugin_urls.txt)
          echo "Total plugins extracted: $total_count"

      - name: Prepare Plugin Metadata
        id: prepare_metadata
        run: |
          echo "Preparing plugin metadata..."
          # å®šä¹‰åˆ†ç±»å˜é‡
          CAT_CHECKIN="âœ… Checkin"
          CAT_TOOLS="ğŸ”¨ Tools"
          CAT_ADBLOCK="ğŸš« AD Block"
          
          # ä» README.md æå–åˆ†ç±»å¹¶å»ºç«‹æ˜ å°„å…³ç³»
          declare -A category_map
          current_category=""

          while IFS= read -r line; do
            # æ£€æŸ¥è¡¨æ ¼ä¸­çš„åˆ†ç±»æ ‡è®°
            if [[ $line == *"<strong>ç­¾åˆ°æ’ä»¶</strong>"* ]]; then
              current_category="$CAT_CHECKIN"
              echo "Found category: ç­¾åˆ°æ’ä»¶ -> $current_category"
            elif [[ $line == *"<strong>åŠŸèƒ½æ’ä»¶</strong>"* ]]; then
              current_category="$CAT_TOOLS"
              echo "Found category: åŠŸèƒ½æ’ä»¶ -> $current_category"
            elif [[ $line == *"<strong>å»å¹¿å‘Šæ’ä»¶</strong>"* ]]; then
              current_category="$CAT_ADBLOCK"
              echo "Found category: å»å¹¿å‘Šæ’ä»¶ -> $current_category"
            elif [[ $line == *"<strong>è‡ªç­¾æ’ä»¶</strong>"* ]]; then
              # è‡ªç­¾æ’ä»¶ä¹Ÿå½’ç±»ä¸ºå»å¹¿å‘Š
              current_category="$CAT_ADBLOCK"
              echo "Found category: è‡ªç­¾æ’ä»¶ -> $current_category"
            elif [[ $line =~ href=\"https://www\.nsloon\.com/openloon/import\?plugin= && -n "$current_category" ]]; then
              # æå–æ’ä»¶URL
              plugin_url=$(echo "$line" | grep -oP '(?<=plugin=)[^"]+')
              if [[ -n "$plugin_url" ]]; then
                 # æå–åŸºç¡€URL (å»æ‰å¯èƒ½çš„renameå‚æ•°)
                 base_url=$(echo "$plugin_url" | cut -d'?' -f1)
                 if [[ -n "$base_url" ]]; then
                    category_map["$base_url"]="$current_category"
                    echo "Mapped: $base_url -> $current_category"
                 fi
              fi
            fi
          done < README.md
          echo "Finished reading README for categories."

          # å¤„ç†æ‰€æœ‰æ’ä»¶ï¼Œç¡®å®šåç§°å’Œæœ€ç»ˆåˆ†ç±»
          plugin_metadata='[]' # Initialize as empty JSON array

          while IFS= read -r plugin_full_url; do
            echo "Processing URL: $plugin_full_url"
            # Extract custom name and base url
            if [[ "$plugin_full_url" == *"?rename="* ]]; then
              plugin_name=$(echo "$plugin_full_url" | grep -oP '(?<=\?rename=)[^&]+')
              base_url=$(echo "$plugin_full_url" | cut -d'?' -f1)
              echo "  Custom name found: $plugin_name, Base URL: $base_url"
            else
              plugin_name=$(basename "$plugin_full_url" .plugin)
              base_url="$plugin_full_url"
              echo "  Default name: $plugin_name, Base URL: $base_url"
            fi

            # ç¡®å®šåˆ†ç±» (ä¼˜å…ˆä½¿ç”¨æ˜ å°„ï¼Œå¦åˆ™ä½¿ç”¨å…³é”®å­—)
            if [[ -n "${category_map[$base_url]}" ]]; then
              category="${category_map[$base_url]}"
              echo "  Using mapped category: $category"
            else
              echo "  No mapped category found for $base_url. Using fallback."
              # è½¬æ¢ä¸ºå°å†™è¿›è¡ŒåŒ¹é…
              combined_lower=$(echo "$plugin_full_url$plugin_name" | tr '[:upper:]' '[:lower:]')
              # å¹¿å‘Šæ‹¦æˆªç±»
              if [[ "$combined_lower" =~ (remove.*ads|ads.*remove|ad.*block|block.*ad|å¹¿å‘Š|å‡€åŒ–|advertis|anti.?ad|remove_watermark|ssl_unpinning|filter|clean|purify|privacy|éšç§|blocker|å»å¹¿å‘Š|adguard|æ‹¦æˆª|intercept) ]]; then
                category="$CAT_ADBLOCK"
              # ç­¾åˆ°ç±»
              elif [[ "$combined_lower" =~ (checkin|sign|ç­¾åˆ°|dailybonus|bonus|signin|æ‰“å¡|ç™»å½•å¥–åŠ±|æ¯æ—¥ç­¾åˆ°|daily.?reward) ]]; then
                category="$CAT_CHECKIN"
              # åŠŸèƒ½å¢å¼ºç±»
              elif [[ "$combined_lower" =~ (unlock|è§£é”|enhance|å¢å¼º|åŠŸèƒ½|feature|redirect|è½¬å‘|utility|mount|æŒ‚è½½|translation|repair|external_links|query|detection|auto_join) ]]; then
                category="$CAT_TOOLS"
              # é»˜è®¤ä¸ºå·¥å…·ç±»
              else
                category="$CAT_TOOLS"
              fi
              echo "  Fallback category determined: $category"
            fi

            # å°†ä¿¡æ¯æ·»åŠ åˆ°JSONæ•°ç»„ (ç¡®ä¿æ­£ç¡®è½¬ä¹‰)
            json_entry=$(jq -n --arg url "$plugin_full_url" --arg name "$plugin_name" --arg category "$category" '{url: $url, name: $name, category: $category}')
            plugin_metadata=$(echo "$plugin_metadata" | jq --argjson entry "$json_entry" '. + [$entry]')

          done < plugin_urls.txt

          # ä¿å­˜å…ƒæ•°æ®åˆ°JSONæ–‡ä»¶
          echo "Final metadata JSON: $plugin_metadata"
          echo "$plugin_metadata" > plugin_metadata.json
          echo "Plugin metadata saved to plugin_metadata.json"

      - name: Download Netease Cloud Music Ad Removal Module
        run: |
          # ç½‘æ˜“äº‘æ¨¡å—å•ç‹¬å¤„ç†ï¼Œä¸ä½¿ç”¨ä¸Šè¿°å…ƒæ•°æ®
          mkdir -p Surge/Modules
          encoded_name=$(echo "NetEase Music AdBlock" | jq -sRr @uri)
          encoded_desc=$(echo "Ad removal for NetEase Music" | jq -sRr @uri)
          encoded_category=$(echo "ğŸš« AD Block" | jq -sRr @uri)
          download_url="http://localhost:9101/file/_start_/https://raw.githubusercontent.com/Keywos/rule/main/script/wy/wy.sgmodule/_end_/Netease_Music_AdBlock.sgmodule?type=surge-module&target=surge-module&del=true&n=${encoded_name}&y=${encoded_desc}&category=${encoded_category}&jqEnabled=true"

          echo "Downloading Netease Music AdBlock module via ScriptHub"
          curl -A "script-hub/1.0.0" -L -o "Surge/Modules/Netease_Music_AdBlock.sgmodule" "$download_url" || echo "Failed to download Netease_Music_AdBlock.sgmodule"

      - name: Process Loon plugins to Surge modules
        run: |
          echo "Processing Loon plugins..."
          mkdir -p Surge/Modules

          # è¯»å–ä¹‹å‰ç”Ÿæˆçš„å…ƒæ•°æ®æ–‡ä»¶
          jq -c '.[]' plugin_metadata.json | while IFS= read -r entry; do
              plugin_full_url=$(echo "$entry" | jq -r '.url')
              plugin_name=$(echo "$entry" | jq -r '.name')
              category=$(echo "$entry" | jq -r '.category')

              echo "Processing $plugin_name ($category) from $plugin_full_url"

              encoded_category=$(echo "$category" | jq -sRr @uri)
              encoded_plugin_name=$(echo "$plugin_name" | jq -sRr @uri)

              # æ„å»ºä¸‹è½½URL (Loon -> Surge)
              # æ³¨æ„ï¼šè¿™é‡Œçš„ source URL ($plugin_full_url) å¯èƒ½æ˜¯åŒ…å« ?rename= çš„å®Œæ•´URL
              # ScriptHub åº”è¯¥èƒ½æ­£ç¡®å¤„ç†è¿™ç§æƒ…å†µï¼Œå› ä¸ºå®ƒä¼šè§£æ _start_ å’Œ _end_ ä¹‹é—´çš„å†…å®¹ä½œä¸ºæºURL
              download_url="http://localhost:9101/file/_start_/${plugin_full_url}/_end_/${encoded_plugin_name}.sgmodule?type=loon-plugin&target=surge-module&sni=%20%2C%20&del=true&pm=REJECT&category=${encoded_category}&jqEnabled=true"

              echo "  Download URL: $download_url"
              curl -A "script-hub/1.0.0" -L -o "Surge/Modules/${plugin_name}.sgmodule" "$download_url" || echo "  Failed to download ${plugin_name}.sgmodule"
          done
          echo "Finished processing Loon plugins."

      - name: Find and replace external JS resources
        continue-on-error: true  # ç¡®ä¿æ­¥éª¤åœ¨éƒ¨åˆ†å¤±è´¥æ—¶ç»§ç»­æ‰§è¡Œ
        shell: bash
        run: |
          set -e
          base_js_url="https://github.com/lucking7/esdeath/raw/main/Surge/Scripts"
          mirror_key="github.com/lucking7/esdeath"  # æ’é™¤å·²é•œåƒçš„æ–‡ä»¶
          mkdir -p Surge/Scripts
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ç”Ÿæˆçš„ sgmodule æ–‡ä»¶
          if [ ! -d "Surge/Modules" ] || [ -z "$(ls -A Surge/Modules/*.sgmodule 2>/dev/null)" ]; then
            echo "No sgmodule files found to process"
            exit 0
          fi
          
          echo "Generated sgmodule files:"
          ls -la Surge/Modules/*.sgmodule
          
          # æå–æ‰€æœ‰ JavaScript URL - ä½¿ç”¨æ›´ç²¾ç¡®çš„æ­£åˆ™è¡¨è¾¾å¼
          echo "Searching for JS URLs..."
          
          find Surge/Modules -name "*.sgmodule" \
            -exec grep -hoE 'script-path\s*=\s*https?://[^[:space:],"]+\.js[^[:space:],"]*' {} \; 2>/dev/null \
            | sed -E 's/^script-path\s*=\s*//' \
            | sort -u > external-js-raw.txt || touch external-js-raw.txt
          
          echo "Found JavaScript URLs:"
          cat external-js-raw.txt || echo "No JS URLs found"
          
          # è¿‡æ»¤æ‰å·²ç»æŒ‡å‘é•œåƒçš„ URL
          if [ -s external-js-raw.txt ]; then
            grep -v "$mirror_key" external-js-raw.txt \
              | grep -v "$base_js_url" > external-js.txt \
              || touch external-js.txt
          else
            touch external-js.txt
          fi
          
          echo "External JS URLs to mirror:"
          cat external-js.txt || echo "No external JS URLs to mirror"

          # å¦‚æœæ²¡æœ‰éœ€è¦é•œåƒçš„ JS æ–‡ä»¶ï¼Œç›´æ¥é€€å‡º
          if [ ! -s external-js.txt ]; then
            echo "No external JS links found to mirror."
            rm -f external-js.txt external-js-raw.txt
            exit 0
          fi

          # ä¸‹è½½å¹¶é•œåƒ JS æ–‡ä»¶
          echo "Processing external JS files:"
          failed_downloads=0
          successful_downloads=0
          
          while IFS= read -r url; do
            [ -z "$url" ] && continue
            
            # æå–æ–‡ä»¶åï¼Œå¤„ç†å¯èƒ½çš„æŸ¥è¯¢å‚æ•°
            filename=$(basename "${url%%[\?#]*}")
            
            # ç¡®ä¿æ–‡ä»¶åä»¥ .js ç»“å°¾
            if [[ ! "$filename" =~ \.js$ ]]; then
              filename="${filename}.js"
            fi
            
            local_js_path="Surge/Scripts/$filename"
            echo "Mirroring: $url â†’ $local_js_path"
            
            # ä¸‹è½½æ–‡ä»¶ - æ·»åŠ è¶…æ—¶æ§åˆ¶å’Œæ›´è¯¦ç»†çš„é”™è¯¯å¤„ç†
            if curl -Ls --connect-timeout 30 --max-time 60 \
                    -A "script-hub/1.0.0" \
                    "$url" -o "$local_js_path"; then
              
              # æ£€æŸ¥ä¸‹è½½çš„æ–‡ä»¶æ˜¯å¦ä¸ºç©ºæˆ–è¿‡å°
              if [ -s "$local_js_path" ] && [ "$(stat -c%s "$local_js_path" 2>/dev/null || stat -f%z "$local_js_path")" -gt 10 ]; then
                echo "âœ“ Successfully downloaded $filename ($(stat -c%s "$local_js_path" 2>/dev/null || stat -f%z "$local_js_path") bytes)"
                
                # åœ¨æ‰€æœ‰ sgmodule æ–‡ä»¶ä¸­æ›¿æ¢é“¾æ¥ - ä½¿ç”¨æ›´ç²¾ç¡®çš„æ›¿æ¢
                mirror_url="$base_js_url/$filename"
                find Surge/Modules -name "*.sgmodule" -type f \
                  -exec perl -pi -e "s,\Q${url}\E,${mirror_url},g" {} \; 2>/dev/null || \
                  find Surge/Modules -name "*.sgmodule" -type f \
                    -exec sed -i "s|$url|$mirror_url|g" {} \;
                
                echo "âœ“ Updated links: $url â†’ $mirror_url"
                ((successful_downloads++))
              else
                echo "âœ— Downloaded file is empty or too small: $filename"
                rm -f "$local_js_path"
                ((failed_downloads++))
              fi
            else
              echo "âœ— Failed to download: $url"
              ((failed_downloads++))
            fi
            
            # æ·»åŠ çŸ­æš‚å»¶è¿Ÿï¼Œé¿å…è¯·æ±‚è¿‡äºé¢‘ç¹
            sleep 0.5
          done < external-js.txt
          
          echo ""
          echo "ğŸ“Š Processing Summary:"
          echo "  âœ“ Successful downloads: $successful_downloads"
          echo "  âœ— Failed downloads: $failed_downloads"
          echo "  ğŸ“ Total JS files in Surge/Scripts: $(ls -1 Surge/Scripts/*.js 2>/dev/null | wc -l)"
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f external-js.txt external-js-raw.txt
          
          # å¦‚æœæœ‰å¤ªå¤šå¤±è´¥ï¼Œç»™å‡ºè­¦å‘Š
          if [ $failed_downloads -gt 0 ] && [ $successful_downloads -eq 0 ]; then
            echo "âš ï¸  Warning: All JS downloads failed. Please check network connectivity."
          elif [ $failed_downloads -gt 5 ]; then
            echo "âš ï¸  Warning: High number of failed downloads ($failed_downloads). Some modules may not work properly."
          fi

      - name: Add ruleset to fmz200's module
        run: |
          fmz_module="Surge/Modules/Remove_ads_by_fmz.sgmodule"
          if [ -f "$fmz_module" ]; then
            echo "Adding ruleset to $fmz_module"
            
            # æ£€æŸ¥æ–‡ä»¶ä¸­æ˜¯å¦å·²æœ‰[Rule]éƒ¨åˆ†
            if grep -q "\[Rule\]" "$fmz_module"; then
              # åœ¨[Rule]éƒ¨åˆ†åæ·»åŠ è§„åˆ™é›†
              sed -i '/\[Rule\]/a RULE-SET,https://ruleset.chichi.sh/Rulesets/reject/reject_fmz200.list ,REJECT,pre-matching,extended-matching,no-resolve' "$fmz_module"
              echo "Added ruleset after existing [Rule] section"
            else
              # å¦‚æœæ²¡æœ‰[Rule]éƒ¨åˆ†ï¼Œæ·»åŠ æ–°çš„éƒ¨åˆ†
              echo -e "\n[Rule]\nRULE-SET,https://ruleset.chichi.sh/Rulesets/reject/reject_fmz200.list ,REJECT,pre-matching,extended-matching,no-resolve" >> "$fmz_module"
              echo "Added new [Rule] section with ruleset"
            fi
          else
            echo "Warning: $fmz_module not found"
          fi

      - name: Commit and push changes
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶éœ€è¦æäº¤
          echo "ğŸ” Checking for files to commit..."
          
          if [ ! -d "Surge/Modules" ] && [ ! -d "Surge/Scripts" ]; then
            echo "ğŸ“­ No Surge directories found to commit."
            exit 0
          fi
          
          # æš‚å­˜éœ€è¦ç®¡æ§çš„æ–‡ä»¶
          echo "ğŸ“¦ Staging files..."
          find Surge/Modules -name "*.sgmodule" -exec git add {} + 2>/dev/null || true
          find Surge/Scripts -name "*.js" -exec git add {} + 2>/dev/null || true
          
          # æ£€æŸ¥æš‚å­˜åŒºæ˜¯å¦ä¸ºç©º
          if git diff --cached --quiet; then
            echo "ğŸ“ No changes to commit."
            exit 0
          fi
          
          # æ˜¾ç¤ºå°†è¦æäº¤çš„å˜åŒ–
          echo "ğŸ“‹ Changes to be committed:"
          git diff --cached --name-status
          
          echo ""
          echo "ğŸ“Š File statistics:"
          sgmodule_count=$(git diff --cached --name-only | grep "\.sgmodule$" | wc -l || echo "0")
          js_count=$(git diff --cached --name-only | grep "\.js$" | wc -l || echo "0")
          echo "  ğŸ“„ SGModule files: $sgmodule_count"
          echo "  ğŸ“œ JavaScript files: $js_count"
          
          # åŒæ­¥è¿œç«¯å˜åŒ–
          echo "ğŸ”„ Syncing with remote..."
          git fetch origin
          
          if git diff --quiet HEAD origin/main; then
            echo "âœ… Local branch is up to date with origin/main"
          else
            echo "â¬‡ï¸  Pulling latest changes from origin..."
            git pull --rebase origin main
            
            # rebase åé‡æ–°æ·»åŠ æ–‡ä»¶
            echo "ğŸ”„ Re-staging files after rebase..."
            find Surge/Modules -name "*.sgmodule" -exec git add {} + 2>/dev/null || true
            find Surge/Scripts -name "*.js" -exec git add {} + 2>/dev/null || true
            
            # rebase åå†æ¬¡æ£€æŸ¥
            if git diff --cached --quiet; then
              echo "ğŸ“ No changes to commit after rebase."
              exit 0
            fi
          fi
          
          # æäº¤å˜åŒ–
          commit_msg="ğŸ”„ Update sgmodule files with GitHub-hosted JS resources - $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ’¾ Committing changes..."
          git commit -m "$commit_msg"
          
          # å®‰å…¨æ¨é€ï¼šå¤„ç†å¯èƒ½çš„è¿œç¨‹æ›´æ”¹
          echo "â¬†ï¸  Pushing changes to remote..."
          max_retries=3
          retry_count=0
          
          while [ $retry_count -lt $max_retries ]; do
            if git push; then
              echo "âœ… Successfully pushed changes to remote!"
              break
            else
              retry_count=$((retry_count + 1))
              echo "âŒ Push failed (attempt $retry_count/$max_retries)"
              
              if [ $retry_count -lt $max_retries ]; then
                echo "ğŸ”„ Syncing remote changes and retrying..."
                git pull --rebase || {
                  echo "âš ï¸  Rebase failed, using merge strategy..."
                  git pull --no-rebase
                }
                sleep 2  # çŸ­æš‚å»¶è¿Ÿ
              else
                echo "ğŸ’¥ Reached maximum retry attempts, push failed!"
                echo "ğŸ” Current git status:"
                git status --porcelain
                exit 1
              fi
            fi
          done
          
          echo ""
          echo "ğŸ‰ Conversion workflow completed successfully!"
          echo "ğŸ“Š Final summary:"
          echo "  ğŸ“ Repository: $(git remote get-url origin)"
          echo "  ğŸ·ï¸  Latest commit: $(git rev-parse --short HEAD)"
          echo "  ğŸ“… Timestamp: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S CST')"

      - name: Trigger Merge Workflow
        if: success()
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: trigger-merge
