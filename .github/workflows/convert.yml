name: Loon to Surge Module Conversion

on:
  repository_dispatch:
    types: [trigger-convert]
  workflow_dispatch:
  schedule:
    - cron: '5,30,55 * * * *'

# å¹¶å‘æ§åˆ¶ï¼Œé¿å…é‡å¤è½¬æ¢
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  convert:
    name: Convert Plugins
    runs-on: ubuntu-latest
    permissions:
      contents: write
    services:
      docker:
        image: xream/script-hub:latest
        ports:
          - 9100:9100
          - 9101:9101
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # æ·»åŠ Node.jså’Œpnpmè®¾ç½®ï¼Œæ–¹ä¾¿ä»¥åæ‰©å±•åŠŸèƒ½
      - name: è®¾ç½®PNPM
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: ".node-version"
          cache: "pnpm"

      - name: é…ç½®Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq netcat-openbsd

      - name: ç­‰å¾…DockeræœåŠ¡å°±ç»ª
        run: |
          echo "ç­‰å¾…DockeræœåŠ¡å°±ç»ª..."
          for i in {1..10}; do
            nc -z localhost 9101 && break
            sleep 10
          done

      - name: ä¸‹è½½README
        run: |
          curl -s -o README.md https://raw.githubusercontent.com/luestr/ProxyResource/main/README.md

      - name: æå–æ’ä»¶URLs
        run: |
          grep -oP 'https?://[^ )"]+\?plugin=[^ )"]+' README.md > plugin_urls_raw.txt
          grep -oP '(?<=\?plugin=)[^ )"]+' plugin_urls_raw.txt > plugin_urls.txt
          
          # æ·»åŠ fmz200çš„blockAdsæ’ä»¶å¹¶è‡ªå®šä¹‰åç§°
          echo "https://raw.githubusercontent.com/fmz200/wool_scripts/main/Loon/plugin/blockAds.plugin?rename=Remove_ads_by_fmz" >> plugin_urls.txt

      - name: æå–åˆ†ç±»å¹¶å¤„ç†æ’ä»¶
        run: |
          mkdir -p Surge/Modules
          
          # ä» README.md æå–åˆ†ç±»å¹¶å»ºç«‹æ˜ å°„å…³ç³»
          declare -A category_map
          current_category=""
          
          while IFS= read -r line; do
            if [[ $line == *"### ç­¾åˆ°æ’ä»¶"* ]]; then
              current_category="âœ… Checkin"
            elif [[ $line == *"### åŠŸèƒ½æ’ä»¶"* ]]; then
              current_category="ğŸ”¨ Tools"
            elif [[ $line == *"### å»å¹¿å‘Šæ’ä»¶"* ]]; then
              current_category="ğŸš« AD Block"
            elif [[ $line =~ "https://" && -n "$current_category" ]]; then
              # æå–URLå’Œåç§°
              plugin_url=$(echo "$line" | grep -oP 'https://[^)"\s]+')
              if [[ -n "$plugin_url" ]]; then
                category_map["$plugin_url"]="$current_category"
                echo "Mapped $plugin_url to $current_category"
              fi
            fi
          done < README.md
          
          # å¤„ç†æ’ä»¶ä¸‹è½½
          while read -r plugin_url; do
            # æå–è‡ªå®šä¹‰åç§°ï¼ˆå¦‚æœæœ‰æŒ‡å®šï¼‰
            if [[ "$plugin_url" == *"?rename="* ]]; then
              plugin_name=$(echo "$plugin_url" | grep -oP '(?<=\?rename=)[^&]+')
              base_url=$(echo "$plugin_url" | cut -d'?' -f1)
            else
              plugin_name=$(basename "$plugin_url" .plugin)
              base_url="$plugin_url"
            fi
            
            # ç¡®å®šåˆ†ç±»
            if [[ -n "${category_map[$base_url]}" ]]; then
              category="${category_map[$base_url]}"
              echo "Using mapped category for $base_url: $category"
            else
              # è½¬æ¢ä¸ºå°å†™è¿›è¡ŒåŒ¹é…
              combined_lower=$(echo "$plugin_url$plugin_name" | tr '[:upper:]' '[:lower:]')
              
              # å¹¿å‘Šæ‹¦æˆªç±»
              if [[ "$combined_lower" =~ (remove.*ads|ads.*remove|ad.*block|block.*ad|å¹¿å‘Š|å‡€åŒ–|advertis|anti.?ad|remove_watermark|ssl_unpinning|filter|clean|purify|privacy|éšç§|blocker|å»å¹¿å‘Š|adguard|æ‹¦æˆª|intercept) ]]; then
                category="ğŸš« AD Block"
              # ç­¾åˆ°ç±»
              elif [[ "$combined_lower" =~ (checkin|sign|ç­¾åˆ°|dailybonus|bonus|signin|æ‰“å¡|ç™»å½•å¥–åŠ±|æ¯æ—¥ç­¾åˆ°|daily.?reward) ]]; then
                category="âœ… Checkin"
              # åŠŸèƒ½å¢å¼ºç±»
              elif [[ "$combined_lower" =~ (unlock|è§£é”|enhance|å¢å¼º|åŠŸèƒ½|feature|redirect|è½¬å‘|utility|mount|æŒ‚è½½|translation|repair|external_links|query|detection|auto_join) ]]; then
                category="ğŸ”¨ Tools"
              # é»˜è®¤ä¸ºå·¥å…·ç±»
              else
                category="ğŸ”¨ Tools"
              fi
              echo "Using fallback category for $plugin_url: $category"
            fi
            
            encoded_category=$(echo "$category" | jq -sRr @uri)
            encoded_plugin_name=$(echo "$plugin_name" | jq -sRr @uri)
            download_url="http://localhost:9101/file/_start_/${plugin_url}/_end_/${encoded_plugin_name}.sgmodule?type=loon-plugin&target=surge-module&target=surge-module&sni=%20%2C%20&del=true&pm=REJECT&category=${encoded_category}&jqEnabled=true"
            
            echo "Processing $plugin_name with category: $category"
            curl -A "Surge Mac/2985" -L -o "Surge/Modules/${plugin_name}.sgmodule" "$download_url" || echo "Failed to download ${plugin_name}.sgmodule"
          done < plugin_urls.txt

      - name: æŸ¥æ‰¾å¹¶æ›¿æ¢å¤–éƒ¨JSèµ„æº
        continue-on-error: true  # ç¡®ä¿æ­¥éª¤åœ¨éƒ¨åˆ†å¤±è´¥æ—¶ç»§ç»­æ‰§è¡Œ
        run: |
          base_js_url="https://github.com/ilychi/esdeath/raw/main/Surge/Scripts"
          mkdir -p Surge/Scripts
          for sgmodule_file in Surge/Modules/*.sgmodule; do
            echo "å¤„ç†æ–‡ä»¶: $sgmodule_file"
            # æŸ¥æ‰¾ .js æ–‡ä»¶çš„å¤–éƒ¨é“¾æ¥
            js_links=$(grep -oP 'https?://[^ ]+\.js' "$sgmodule_file" || echo "")
            for js_link in $js_links; do
              js_filename=$(basename "$js_link")
              local_js_path="Surge/Scripts/$js_filename"
              # ä½¿ç”¨æŒ‡å®šçš„ User-Agent ä¸‹è½½ .js æ–‡ä»¶
              echo "æ­£åœ¨ä¸‹è½½: $js_link åˆ° $local_js_path"
              if curl -A "Surge Mac/2985" -L -o "$local_js_path" "$js_link"; then
                echo "ä¸‹è½½æˆåŠŸ: $js_link"
                # æ›¿æ¢ sgmodule æ–‡ä»¶ä¸­çš„é“¾æ¥ä¸º GitHub ä»“åº“çš„è·¯å¾„
                github_js_url="$base_js_url/$js_filename"
                sed -i "s|$js_link|$github_js_url|g" "$sgmodule_file"
              else
                echo "ä¸‹è½½å¤±è´¥ï¼Œè·³è¿‡: $js_link"
              fi
            done
          done

      - name: æäº¤å¹¶æ¨é€æ›´æ”¹
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git add Surge/Modules/*.sgmodule Surge/Scripts/*.js
          if git diff --cached --quiet; then
            echo "æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          else
            git stash
            git pull --rebase  # åŒæ­¥è¿œç¨‹ä»“åº“çš„æœ€æ–°æ›´æ”¹ä»¥é¿å…å†²çª
            git stash pop  # æ¢å¤ä¹‹å‰çš„æ›´æ”¹
            git add Surge/Modules/*.sgmodule Surge/Scripts/*.js  # å†æ¬¡æ·»åŠ æ–‡ä»¶
            git commit -m "æ›´æ–°sgmoduleæ–‡ä»¶å’Œæ‰˜ç®¡åœ¨GitHubçš„JSèµ„æº"
            git push
          fi

      - name: è§¦å‘åˆå¹¶å·¥ä½œæµ
        if: success()
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: trigger-merge

