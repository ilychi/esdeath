name: Main Build Pipeline

on:
  push:
    branches:
      - main
  pull_request:
  schedule:
    - cron: '0 */3 * * *'  # æ¯3å°æ—¶æ‰§è¡Œä¸€æ¬¡
  workflow_dispatch:
    inputs:
      clearCache:
        description: 'æ¸…ç†ç¼“å­˜'
        required: false
        type: boolean
        default: false
  repository_dispatch:
    types: [trigger-main-build]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  main_build:
    name: ä¸»æ„å»ºæµç¨‹
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 120
    permissions:
      contents: write

    services:
      docker:
        image: xream/script-hub:latest
        ports:
          - 9100:9100
          - 9101:9101

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è·å–å½“å‰æ—¥æœŸ
        id: date
        run: |
          echo "date=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT
          echo "year=$(date +'%Y')" >> $GITHUB_OUTPUT
          echo "month=$(date +'%m')" >> $GITHUB_OUTPUT
          echo "day=$(date +'%d')" >> $GITHUB_OUTPUT
          echo "hour=$(date +'%H')" >> $GITHUB_OUTPUT
          echo "minute=$(date +'%M')" >> $GITHUB_OUTPUT
          echo "second=$(date +'%S')" >> $GITHUB_OUTPUT

      - name: æ¢å¤ç¼“å­˜
        uses: actions/cache/restore@v4
        id: cache-restore
        with:
          path: |
            .cache
            .cache/*.db
            .cache/*.db-wal
            .cache/*.db-shm
          key: ${{ runner.os }}-build-cache-v4-${{ steps.date.outputs.year }}-${{ steps.date.outputs.month }}-${{ steps.date.outputs.day }} ${{ steps.date.outputs.hour }}:${{ steps.date.outputs.minute }}:${{ steps.date.outputs.second }}
          restore-keys: |
            ${{ runner.os }}-build-cache-v4-${{ steps.date.outputs.year }}-${{ steps.date.outputs.month }}-${{ steps.date.outputs.day }} ${{ steps.date.outputs.hour }}:${{ steps.date.outputs.minute }}:
            ${{ runner.os }}-build-cache-v4-${{ steps.date.outputs.year }}-${{ steps.date.outputs.month }}-${{ steps.date.outputs.day }} ${{ steps.date.outputs.hour }}:
            ${{ runner.os }}-build-cache-v4-${{ steps.date.outputs.year }}-${{ steps.date.outputs.month }}-${{ steps.date.outputs.day }}
            ${{ runner.os }}-build-cache-v4-${{ steps.date.outputs.year }}-${{ steps.date.outputs.month }}-
            ${{ runner.os }}-build-cache-v4-${{ steps.date.outputs.year }}-
            ${{ runner.os }}-build-cache-v4-

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        run: |
          npm ci
          sudo apt-get update
          sudo apt-get install -y curl jq netcat-openbsd

      - name: åŒæ­¥è§„åˆ™æº
        if: github.event_name == 'schedule' || github.event_name == 'repository_dispatch'
        run: |
          echo "å¼€å§‹åŒæ­¥è§„åˆ™æº..."
          npm run sync
        env:
          TZ: 'Asia/Shanghai'

      - name: ç­‰å¾… Docker æœåŠ¡å°±ç»ª
        run: |
          echo "ç­‰å¾… Docker æœåŠ¡å°±ç»ª..."
          for i in {1..10}; do
            nc -z localhost 9101 && break
            sleep 10
          done

      - name: æ™ºèƒ½è½¬æ¢ Loon æ’ä»¶
        run: |
          echo "å¼€å§‹æ™ºèƒ½ Loon åˆ° Surge æ’ä»¶è½¬æ¢..."
          mkdir -p Surge/Modules Surge/Scripts .cache/plugin-checksums
          
          # é…ç½®å¹¶å‘å‚æ•°
          CONCURRENCY=${LOON_CONVERSION_CONCURRENCY:-2}
          echo "è½¬æ¢å¹¶å‘æ•°: $CONCURRENCY"
          
          # ä¸‹è½½æ’ä»¶æºåˆ—è¡¨
          curl -s -o README.md https://raw.githubusercontent.com/luestr/ProxyResource/main/README.md
          
          # æå–æ’ä»¶ URLs
          grep -oP 'https://www\.nsloon\.com/openloon/import\?plugin=[^"]+' README.md > nsloon_urls.txt
          > plugin_urls.txt
          while IFS= read -r line; do
            plugin_url=$(echo "$line" | grep -oP '(?<=plugin=)[^"]+' | sed 's/&amp;/\&/g')
            if [[ -n "$plugin_url" ]]; then
              # URLè§£ç å¤„ç†
              plugin_url=$(echo "$plugin_url" | sed 's/%3A/:/g; s/%2F/\//g; s/%3F/?/g; s/%3D/=/g')
              echo "$plugin_url" >> plugin_urls.txt
            fi
          done < nsloon_urls.txt
          
          # æ·»åŠ ç‰¹æ®Šæ’ä»¶
          echo "https://raw.githubusercontent.com/fmz200/wool_scripts/main/Loon/plugin/blockAds.plugin?rename=Remove_ads_by_fmz" >> plugin_urls.txt
          echo "https://github.com/Keywos/rule/raw/main/script/wy/wy.sgmodule?rename=Netease_Music_Purification" >> plugin_urls.txt
          
          # æ˜¾ç¤ºæ’ä»¶åˆ—è¡¨ä¿¡æ¯
          echo "æ’ä»¶URLæ€»æ•°: $(wc -l < plugin_urls.txt)"
          echo "å‰5ä¸ªæ’ä»¶URL:"
          head -5 plugin_urls.txt
          echo "æœ€å5ä¸ªæ’ä»¶URL:"
          tail -5 plugin_urls.txt
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ— æ•ˆçš„URL
          echo "æ£€æŸ¥URLæ ¼å¼..."
          grep -v "^https\?://" plugin_urls.txt || echo "æ‰€æœ‰URLæ ¼å¼æ­£ç¡®"
          
          # ç›´æ¥ä¸‹è½½å·²ç»æ˜¯ Surge æ ¼å¼çš„æ¨¡å—
          echo "ä¸‹è½½åŸç”Ÿ Surge æ¨¡å—..."
          curl -L -o "Surge/Modules/Netease_Music_Purification.sgmodule" "https://github.com/Keywos/rule/raw/main/script/wy/wy.sgmodule" 2>/dev/null || echo "ä¸‹è½½ç½‘æ˜“äº‘éŸ³ä¹æ¨¡å—å¤±è´¥"
          
          # ä»è½¬æ¢åˆ—è¡¨ä¸­ç§»é™¤å·²ç»æ˜¯ sgmodule çš„æ–‡ä»¶
          grep -v "\.sgmodule" plugin_urls.txt > plugin_urls_filtered.txt || true
          if [[ -f plugin_urls_filtered.txt ]]; then
            mv plugin_urls_filtered.txt plugin_urls.txt
          fi
          
          # æ™ºèƒ½ç¼“å­˜ç­–ç•¥
          plugins_hash=$(md5sum plugin_urls.txt | cut -d' ' -f1)
          cache_file=".cache/converted-modules-${plugins_hash}.tar.gz"
          manifest_file=".cache/conversion-manifest-${plugins_hash}.json"
          
          # æ£€æŸ¥å®Œæ•´ç¼“å­˜
          if [[ -f "$cache_file" ]] && [[ -f "$manifest_file" ]]; then
            cached_count=$(jq length "$manifest_file" 2>/dev/null || echo "0")
            current_count=$(wc -l < plugin_urls.txt)
            
            if [[ "$cached_count" -eq "$current_count" ]]; then
              echo "å‘ç°å®Œæ•´æ’ä»¶ç¼“å­˜ ($cached_count ä¸ªæ’ä»¶)ï¼Œè§£å‹ä½¿ç”¨..."
              tar -xzf "$cache_file" -C Surge/Modules/ 2>/dev/null
              echo "ç¼“å­˜è§£å‹å®Œæˆï¼Œè·³è¿‡è½¬æ¢"
              exit 0
            fi
          fi
          
          # ç­‰å¾…è½¬æ¢æœåŠ¡å°±ç»ª
          echo "ç­‰å¾…è½¬æ¢æœåŠ¡å°±ç»ª..."
          max_wait=60
          wait_count=0
          while ! nc -z localhost 9101 && [ $wait_count -lt $max_wait ]; do
            sleep 3
            wait_count=$((wait_count + 3))
            echo "ç­‰å¾… Script Hub æœåŠ¡... ($wait_count/$max_wait ç§’)"
          done
          
          if ! nc -z localhost 9101; then
            echo "è½¬æ¢æœåŠ¡å¯åŠ¨å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ..."
            # å°è¯•ä½¿ç”¨æœ€æ–°å¯ç”¨ç¼“å­˜
            latest_cache=$(ls -t .cache/converted-modules-*.tar.gz 2>/dev/null | head -1)
            if [[ -f "$latest_cache" ]]; then
              echo "ä½¿ç”¨å¤‡ç”¨ç¼“å­˜: $latest_cache"
              tar -xzf "$latest_cache" -C Surge/Modules/ 2>/dev/null
              exit 0
            else
              echo "æ— å¯ç”¨å¤‡ç”¨æ–¹æ¡ˆï¼Œé€€å‡º"
              exit 1
            fi
          fi
          
          # é¢å¤–ç­‰å¾…æœåŠ¡ç¨³å®š
          echo "ç­‰å¾…æœåŠ¡ç¨³å®š..."
          sleep 5
          
          # å®šä¹‰è½¬æ¢å‡½æ•°
          convert_plugin() {
            local plugin_url="$1"
            local job_id="$2"
            
            # å¤„ç†å¸¦æœ‰ ?rename= å‚æ•°çš„URL
            local clean_url="${plugin_url%%\?*}"
            local rename_param="${plugin_url#*\?rename=}"
            
            if [[ "$rename_param" != "$plugin_url" ]]; then
              # æœ‰ rename å‚æ•°
              local plugin_name="$rename_param"
            else
              # æ²¡æœ‰ rename å‚æ•°ï¼Œä½¿ç”¨æ–‡ä»¶å
              local plugin_name=$(basename "$clean_url" .plugin)
            fi
            
            local output_file="Surge/Modules/${plugin_name}.sgmodule"
            local result_file=".cache/conversion_results_${job_id}.txt"
            
            echo "[Job $job_id] å¼€å§‹è½¬æ¢: $plugin_name"
            echo "[Job $job_id] æ’ä»¶URL: $clean_url"
            echo "[Job $job_id] è¾“å‡ºæ–‡ä»¶: $output_file"
            
            # ä½¿ç”¨ Script Hub è½¬æ¢
            encoded_name=$(echo "$plugin_name" | jq -sRr @uri)
            # ä½¿ç”¨æ ‡å‡† Script Hub æ ¼å¼è€Œä¸æ˜¯ file æ ¼å¼
            download_url="http://localhost:9101/convert/_start_/${clean_url}/_end_/${plugin_name}.sgmodule?type=loon-plugin&target=surge-module"
            
            # ä¸º Remove_ads_by_fmz æ·»åŠ ç‰¹æ®Šå¤„ç†
            if [[ "$plugin_name" == "blockAds" || "$plugin_name" == "Remove_ads_by_fmz" ]]; then
              echo "[Job $job_id] å¤„ç†å¸¦å‚æ•°çš„æ’ä»¶: $plugin_name"
              
              # ä¸‹è½½åŸå§‹ Loon æ’ä»¶ä»¥æå–å‚æ•°
              if curl -s -L "$clean_url" > "/tmp/loon_${job_id}.txt" 2>/dev/null; then
                echo "[Job $job_id] æˆåŠŸä¸‹è½½ Loon æ’ä»¶"
                
                # åˆ›å»ºåŠ¨æ€çš„ evalScriptmodi è„šæœ¬ï¼ˆä½¿ç”¨base64ç¼–ç é¿å…YAMLè¯­æ³•é—®é¢˜ï¼‰
                echo 'Ly8g6Ieq5Yqo5qOA5rWL5bm26L2s5o2i5Y+C5pWw5qC85byPCihmdW5jdGlvbigpIHsKICAvLyDmj5Dlj5bnjrDmnInnmoTlj4LmlbDlrprkuYkKICBjb25zdCBhcmdzTWF0Y2ggPSBib2R5Lm1hdGNoKC9eIyFhcmd1bWVudHM9KC4rKSQvbSk7CiAgY29uc3QgYXJnc0Rlc2NNYXRjaCA9IGJvZHkubWF0Y2goL14jIWFyZ3VtZW50cy1kZXNjPSguKykkL20pOwogIAogIGlmICghYXJnc01hdGNoKSB7CiAgICAvLyDmsqHmnInlj4LmlbDlrprkuYnvvIznm7TmjqXov5Tlm54KICAgIHJldHVybiBib2R5OwogIH0KICAKICAvLyDop6PmnpDlj4LmlbAKICBjb25zdCBhcmdzID0gYXJnc01hdGNoWzFdOwogIGNvbnN0IGFyZ3NNYXAgPSB7fTsKICBhcmdzLnNwbGl0KCcsJykuZm9yRWFjaChhcmcgPT4gewogICAgY29uc3QgW25hbWUsIGRlZmF1bHRWYWx1ZV0gPSBhcmcuc3BsaXQoJzonKTsKICAgIGlmIChuYW1lICYmIGRlZmF1bHRWYWx1ZSkgewogICAgICBhcmdzTWFwW25hbWVdID0gZGVmYXVsdFZhbHVlOwogICAgfQogIH0pOwogIAogIC8vIOafpeaJvuW5tuabv+aNouaJgOaciSB7e3twYXJhbX19fSDmoLzlvI/nmoTljaDkvY3nrKYKICBjb25zdCBzY3JpcHRTZWN0aW9uID0gYm9keS5tYXRjaCgvXFtTY3JpcHRcXShbXHNcU10qPykoPz1cW3wkKS8pOwogIGlmIChzY3JpcHRTZWN0aW9uKSB7CiAgICBsZXQgc2NyaXB0Q29udGVudCA9IHNjcmlwdFNlY3Rpb25bMF07CiAgICAKICAgIC8vIOabv+aNouWNoOS9jeespuagvOW8j+S4uuagh+WHhuagvOW8jwogICAgc2NyaXB0Q29udGVudCA9IHNjcmlwdENvbnRlbnQucmVwbGFjZSgvXnt7eyhbXn1dKyl9fX0gPSAoLispJC9nbSwgZnVuY3Rpb24obWF0Y2gsIHBhcmFtTmFtZSwgc2NyaXB0RGVmKSB7CiAgICAgIC8vIOiHquWKqOajgOa1i+iEmuacrOWQjeensCAgICAgIAogICAgICBsZXQgc2NyaXB0TmFtZSA9IHBhcmFtTmFtZS5yZXBsYWNlKC9fZW5hYmxlJC8sICcnKTsKICAgICAgCiAgICAgIC8vIOWwneivleS7juazqOmHiuaIluiEmuacrOi3r+W+hOS4reaPkOWPluabtOWlveeahOWQjeensCAgICAgIAogICAgICBjb25zdCBwYXRoTWF0Y2ggPSBzY3JpcHREZWYubWF0Y2goL3NjcmlwdC1wYXRoPSouXC8oW15cL10rKVwuanMvKTsKICAgICAgaWYgKHBhdGhNYXRjaCAmJiBwYXRoTWF0Y2hbMV0pIHsKICAgICAgICAvLyDkvb/nlKjohJrmnKzmlofku7blkI3kvZzkuLrlj4LogIMKICAgICAgICBjb25zdCBmaWxlTmFtZSA9IHBhdGhNYXRjaFsxXTsKICAgICAgICAvLyDmmKDlsITkuIDkupvluLjop4HnmoTohJrmnKzlkI0KICAgICAgICBjb25zdCBuYW1lTWFwID0gewogICAgICAgICAgJzEyMzA2JzogJzEyMzA2JywKICAgICAgICAgICc1NTVBZCc6ICc1NTXlvbHop4YnLAogICAgICAgICAgJzUxY2FyZCc6ICc1MeS/oeeUqOWNoeeuoeWutiAnLAogICAgICAgICAgJ2JpbGliaWxpJzogJ+WTlOWTqeWTlOWTqScsCiAgICAgICAgICAnY2NiTGlmZSc6ICflu7rooYznlJ/mtLsnLAogICAgICAgICAgJ2ppbmdkb25nJzogJ+S6rOS4nCcsCiAgICAgICAgICAneGlhb2hvbmdzaHUnOiAn5bCP57qi5LmmJywKICAgICAgICAgICd4aWFueXVfYWRzJzogJ+mXsumxvCcsCiAgICAgICAgICAnY2FpeXVuJzogJ+W9qeS6keWkqeawlCcKICAgICAgICB9OwogICAgICAgIHNjcmlwdE5hbWUgPSBuYW1lTWFwW2ZpbGVOYW1lXSB8fCBzY3JpcHROYW1lOwogICAgICB9CiAgICAgIAogICAgICAvLyDmo4Dmn6XmmK/lkKblt7LmnIkgYXJndW1lbnQg5Y+C5pWwCiAgICAgIGlmICghc2NyaXB0RGVmLmluY2x1ZGVzKCdhcmd1bWVudD0nKSkgewogICAgICAgIC8vIOWcqOmAguW9k+S9jee9ruaeguWKoCBhcmd1bWVudCDlj4LmlbAKICAgICAgICBpZiAoc2NyaXB0RGVmLmluY2x1ZGVzKCcsIHRpbWVvdXQ9JykpIHsKICAgICAgICAgIHNjcmlwdERlZiA9IHNjcmlwdERlZi5yZXBsYWNlKC8sIHRpbWVvdXQ9LywgJywgYXJndW1lbnQ9ZW5hYmxlPSR7JyArIHBhcmFtTmFtZSArICd9LCB0aW1lb3V0PScpOwogICAgICAgIH0gZWxzZSBpZiAoc2NyaXB0RGVmLmluY2x1ZGVzKCcsIHJlcXVpcmVzLWJvZHk9JykpIHsKICAgICAgICAgIHNjcmlwdERlZiA9IHNjcmlwdERlZi5yZXBsYWNlKC8sIHJlcXVpcmVzLWJvZHk9LywgJywgYXJndW1lbnQ9ZW5hYmxlPSR7JyArIHBhcmFtTmFtZSArICd9LCByZXF1aXJlcy1ib2R5PScpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyDlnKjohJrmnKzot6/lvoTlkI7mt7vliqAKICAgICAgICAgIHNjcmlwdERlZiA9IHNjcmlwdERlZi5yZXBsYWNlKC9zY3JpcHQtcGF0aD0oW14sXSspLywgJ3NjcmlwdC1wYXRoPSQxLCBhcmd1bWVudD1lbmFibGU9JHsnICsgcGFyYW1OYW1lICsgJ30nKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgCiAgICAgIHJldHVybiBzY3JpcHROYW1lICsgJyA9ICcgKyBzY3JpcHREZWY7CiAgICB9KTsKICAgIAogICAgLy8g5pu/5o2i5ZueIGJvZHkKICAgIGJvZHkgPSBib2R5LnJlcGxhY2UoL1xbU2NyaXB0XF0oW1xzXFNdKj8pKD89XFt8JCkvLCBzY3JpcHRDb250ZW50KTsKICB9CiAgCiAgLy8g5L+u5aSN5pys5Zyw5Zyw5Z2A6Zeu6aKYCiAgYm9keSA9IGJvZHkucmVwbGFjZSgvaHR0cDpcL1wvMTI3XC4wXC4wXC4xOjkxMFswMV0vZywgJ2h0dHA6Ly9zY3JpcHQuaHViJyk7CiAgCiAgcmV0dXJuIGJvZHk7Cn0pKCk7' | base64 -d > "/tmp/eval_script_${job_id}.js"
                
                # è¯»å–è„šæœ¬å†…å®¹å¹¶è¿›è¡ŒURLç¼–ç 
                eval_script_content=$(cat "/tmp/eval_script_${job_id}.js")
                encoded_eval=$(echo "$eval_script_content" | jq -sRr @uri)
                download_url="${download_url}&evalScriptmodi=${encoded_eval}"
                echo "[Job $job_id] æ·»åŠ äº† evalScriptmodi å‚æ•°"
              else
                echo "[Job $job_id] æ— æ³•ä¸‹è½½ Loon æ’ä»¶"
              fi
            else
              # ä¸»åŠ¨é¢„é˜²æ‰€æœ‰æ¨¡å—çš„æœ¬åœ°åœ°å€é—®é¢˜
              fix_script='body = body.replace(/http:\/\/127\.0\.0\.1:910[01]/g, "http://script.hub")'
              encoded_fix=$(echo "$fix_script" | jq -sRr @uri)
              download_url="${download_url}&evalScriptmodi=${encoded_fix}"
            fi
            
            echo "[Job $job_id] è½¬æ¢URL: $download_url"
            
            # éªŒè¯è¿œç¨‹æ–‡ä»¶æ˜¯å¦å­˜åœ¨å¹¶è·å–ä¿®æ”¹æ—¶é—´
            echo "[Job $job_id] æ£€æŸ¥è¿œç¨‹æ–‡ä»¶..."
            remote_headers=$(curl -A "script-hub/1.0.0" -I -L --connect-timeout 5 --max-time 10 "$clean_url" 2>&1)
            curl_status=$?
            
            if [[ $curl_status -ne 0 ]]; then
              echo "[Job $job_id] curl è¿”å›é”™è¯¯ä»£ç : $curl_status"
              echo "[Job $job_id] é”™è¯¯ä¿¡æ¯: $remote_headers"
              echo "$plugin_name:failed_remote_unavailable" >> "$result_file"
              return 1
            fi
            
            if [[ -z "$remote_headers" ]] || ! echo "$remote_headers" | grep -q "200 OK\|200 ok"; then
              echo "[Job $job_id] è¿œç¨‹æ–‡ä»¶ä¸å¯ç”¨"
              echo "[Job $job_id] Headers: $remote_headers"
              echo "$plugin_name:failed_remote_unavailable" >> "$result_file"
              return 1
            fi
            
            remote_modified=$(echo "$remote_headers" | grep -i "last-modified" | cut -d' ' -f2- | xargs -I {} date -u -d "{}" "+%s" 2>/dev/null || echo "0")
            
            # æ£€æŸ¥æœ¬åœ°æ–‡ä»¶
            if [[ -f "$output_file" ]]; then
              local_modified=$(stat -c "%Y" "$output_file" 2>/dev/null || echo "0")
              
              # ä»…å½“è¿œç¨‹æ–‡ä»¶è¾ƒæ–°æ—¶æ‰æ›´æ–°
              if [[ "$remote_modified" -le "$local_modified" ]]; then
                echo "[Job $job_id] è·³è¿‡æœªæ›´æ–°çš„æ–‡ä»¶"
                echo "$plugin_name:skipped" >> "$result_file"
                return 0
              fi
            fi
            
            # æ‰§è¡Œè½¬æ¢
            echo "[Job $job_id] å¼€å§‹ä¸‹è½½è½¬æ¢..."
            
            # é‡è¯•æœºåˆ¶
            max_retries=3
            retry_count=0
            
            while [ $retry_count -lt $max_retries ]; do
              curl_output=$(curl -A "script-hub/1.0.0" -L --connect-timeout 20 --max-time 60 -o "$output_file" -w "\n%{http_code}\n" "$download_url" 2>&1)
              http_code=$(echo "$curl_output" | tail -n 1)
              
              echo "[Job $job_id] HTTPçŠ¶æ€ç : $http_code (å°è¯• $((retry_count + 1))/$max_retries)"
              
              if [[ "$http_code" == "200" ]] && [[ -s "$output_file" ]]; then
                if grep -q "#!name=" "$output_file"; then
                  echo "[Job $job_id] è½¬æ¢æˆåŠŸ"
                  
                  # å¯¹ç‰¹å®šæ¨¡å—è¿›è¡Œé¢å¤–å¤„ç†
                  case "$plugin_name" in
                    "Remove_ads_by_fmz"|"blockAds")
                      # ç¡®ä¿æ¨¡å—åç§°æ­£ç¡®
                      sed -i 's/#!name=.*/#!name=å¹¿å‘Šæ‹¦æˆª&å‡€åŒ–åˆé›†/' "$output_file"
                      mv "$output_file" "Surge/Modules/Remove_ads_by_fmz.sgmodule"
                      output_file="Surge/Modules/Remove_ads_by_fmz.sgmodule"
                      ;;
                    "Netease_Music_Purification")
                      sed -i 's/ç½‘æ˜“äº‘éŸ³ä¹å…¨é¢å‡€åŒ–/Netease_Music_Purification/g' "$output_file"
                      ;;
                  esac
                  
                  echo "$plugin_name:success" >> "$result_file"
                  return 0
                else
                  echo "[Job $job_id] è½¬æ¢åçš„æ–‡ä»¶æ— æ•ˆï¼ˆç¼ºå°‘ #!name=ï¼‰"
                  echo "[Job $job_id] æ–‡ä»¶å†…å®¹å‰100å­—ç¬¦: $(head -c 100 "$output_file" 2>/dev/null || echo "æ— æ³•è¯»å–")"
                  
                  # å¦‚æœæ˜¯ HTML é”™è¯¯é¡µé¢ï¼Œæ˜¾ç¤ºéƒ¨åˆ†å†…å®¹
                  if grep -q "<html" "$output_file" 2>/dev/null; then
                    echo "[Job $job_id] æ”¶åˆ°HTMLå“åº”ï¼Œå¯èƒ½æ˜¯é”™è¯¯é¡µé¢"
                    echo "[Job $job_id] HTMLå†…å®¹: $(head -n 5 "$output_file" 2>/dev/null)"
                  fi
                  
                  rm -f "$output_file"
                fi
              else
                echo "[Job $job_id] ä¸‹è½½å¤±è´¥"
                echo "[Job $job_id] Curlè¾“å‡º: $curl_output"
                rm -f "$output_file" 2>/dev/null || true
              fi
              
              retry_count=$((retry_count + 1))
              if [ $retry_count -lt $max_retries ]; then
                echo "[Job $job_id] ç­‰å¾…5ç§’åé‡è¯•..."
                sleep 5
              fi
            done
            
            echo "[Job $job_id] è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œè½¬æ¢å¤±è´¥"
            echo "$plugin_name:failed_download" >> "$result_file"
            return 1
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -f "/tmp/loon_${job_id}.txt" "/tmp/eval_script_${job_id}.js" 2>/dev/null || true
          }
          
          # å¯¼å‡ºå‡½æ•°ä¾›å­è¿›ç¨‹ä½¿ç”¨
          export -f convert_plugin
          
          # å¹¶å‘è½¬æ¢é€»è¾‘
          echo "å¼€å§‹å¹¶å‘è½¬æ¢æ’ä»¶ (å¹¶å‘æ•°: $CONCURRENCY)..."
          
          # æ¸…ç†æ—§çš„ç»“æœæ–‡ä»¶
          rm -f .cache/conversion_results_*.txt
            
            # å…ˆæµ‹è¯•å•ä¸ªæ’ä»¶ä»¥æ’æŸ¥é—®é¢˜
            echo "æµ‹è¯•å•ä¸ªæ’ä»¶è½¬æ¢..."
            test_url="https://gitlab.com/lodepuly/vpn_tool/-/raw/master/Tool/Loon/Plugin/12306_remove_ads.plugin"
            echo "æµ‹è¯•URL: $test_url"
            
            # ç›´æ¥æµ‹è¯• Script Hub æœåŠ¡
            test_response=$(curl -s -w "\n%{http_code}" "http://localhost:9101/health" 2>&1 || echo "æœåŠ¡å¥åº·æ£€æŸ¥å¤±è´¥")
            echo "Script Hub å¥åº·æ£€æŸ¥: $test_response"
            
            # ä¹Ÿå°è¯•ä¸€ä¸ªç®€å•çš„è½¬æ¢è¯·æ±‚
            echo "æµ‹è¯• Script Hub è½¬æ¢åŠŸèƒ½..."
            test_conversion=$(curl -s -w "\n%{http_code}" "http://localhost:9101/file/_start_/https://example.com/test.txt/_end_/test.txt" 2>&1 | tail -n 1)
            echo "æµ‹è¯•è½¬æ¢å“åº”ä»£ç : $test_conversion"
            
            # æµ‹è¯•è½¬æ¢
            if [[ -n "$test_url" ]]; then
              convert_plugin "$test_url" "test" || echo "æµ‹è¯•è½¬æ¢å¤±è´¥"
              
              # æ£€æŸ¥æµ‹è¯•ç»“æœ
              if [[ -f ".cache/conversion_results_test.txt" ]]; then
                echo "æµ‹è¯•ç»“æœ: $(cat .cache/conversion_results_test.txt)"
              fi
            fi
            
            # åˆ›å»ºå¹¶å‘ä»»åŠ¡
            job_count=0
            while IFS= read -r plugin_url; do
              # è·³è¿‡ç©ºè¡Œ
              [[ -z "$plugin_url" ]] && continue
              
              # ç­‰å¾…æœ‰ç©ºé—²è¿›ç¨‹æ§½
              while [ $(jobs -r | wc -l) -ge $CONCURRENCY ]; do
                sleep 0.1
              done
              
              # å¯åŠ¨åå°è½¬æ¢ä»»åŠ¡
              convert_plugin "$plugin_url" "$job_count" &
              job_count=$((job_count + 1))
              
              # é¿å…è¿‡å¿«å¯åŠ¨
              sleep 0.1
            done < plugin_urls.txt
            
            # ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
            echo "ç­‰å¾…æ‰€æœ‰è½¬æ¢ä»»åŠ¡å®Œæˆ..."
            wait
            
            # åˆå¹¶ç»“æœ
            echo "åˆå¹¶è½¬æ¢ç»“æœ..."
            declare -A conversion_results
            successful_count=0
            failed_count=0
            skipped_count=0
            
            for result_file in .cache/conversion_results_*.txt; do
              if [[ -f "$result_file" ]]; then
                while IFS=':' read -r plugin_name status; do
                  conversion_results["$plugin_name"]="$status"
                  case "$status" in
                    "success")
                      successful_count=$((successful_count + 1))
                      ;;
                    "skipped")
                      skipped_count=$((skipped_count + 1))
                      ;;
                    *)
                      failed_count=$((failed_count + 1))
                      ;;
                  esac
                done < "$result_file"
              fi
            done
            
            # åˆ›å»ºè½¬æ¢æ¸…å•
            echo "{" > "$manifest_file"
            echo "  \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"," >> "$manifest_file"
            echo "  \"total_plugins\": $(wc -l < plugin_urls.txt)," >> "$manifest_file"
            echo "  \"successful\": $successful_count," >> "$manifest_file"
            echo "  \"failed\": $failed_count," >> "$manifest_file"
            echo "  \"skipped\": $skipped_count," >> "$manifest_file"
            echo "  \"concurrency\": $CONCURRENCY," >> "$manifest_file"
            echo "  \"results\": {" >> "$manifest_file"
            
            first=true
            for plugin in "${!conversion_results[@]}"; do
              if [[ "$first" == "true" ]]; then
                first=false
              else
                echo "," >> "$manifest_file"
              fi
              echo "    \"$plugin\": \"${conversion_results[$plugin]}\"" >> "$manifest_file"
            done
            
            echo "" >> "$manifest_file"
            echo "  }" >> "$manifest_file"
            echo "}" >> "$manifest_file"
            
            # åˆ›å»ºç¼“å­˜
            if [[ $successful_count -gt 0 ]] || [[ $skipped_count -gt 0 ]]; then
              echo "åˆ›å»ºè½¬æ¢ç¼“å­˜..."
              tar -czf "$cache_file" -C Surge/Modules/ . 2>/dev/null || true
            fi
            
            # è¾“å‡ºç»Ÿè®¡
            total_plugins=$(wc -l < plugin_urls.txt)
            success_rate=$((((successful_count + skipped_count) * 100) / total_plugins))
            
            echo "============================================"
            echo "è½¬æ¢å®Œæˆç»Ÿè®¡:"
            echo "  æ€»æ’ä»¶æ•°: $total_plugins"
            echo "  è½¬æ¢æˆåŠŸ: $successful_count"
            echo "  è·³è¿‡æœªæ›´æ–°: $skipped_count"
            echo "  è½¬æ¢å¤±è´¥: $failed_count"
            echo "  æˆåŠŸç‡: ${success_rate}%"
            echo "  å¹¶å‘æ•°: $CONCURRENCY"
            echo "============================================"
            
            # è®¾ç½® GitHub Actions è¾“å‡º
            echo "conversion_success_rate=$success_rate" >> $GITHUB_OUTPUT
            echo "converted_plugins=$successful_count" >> $GITHUB_OUTPUT
            echo "skipped_plugins=$skipped_count" >> $GITHUB_OUTPUT
            
            # æ¸…ç†æ—§ç¼“å­˜ï¼ˆä¿ç•™æœ€æ–°5ä¸ªï¼‰
            ls -t .cache/converted-modules-*.tar.gz 2>/dev/null | tail -n +6 | xargs rm -f 2>/dev/null || true
            ls -t .cache/conversion-manifest-*.json 2>/dev/null | tail -n +6 | xargs rm -f 2>/dev/null || true
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -f .cache/conversion_results_*.txt
          env:
            LOON_CONVERSION_CONCURRENCY: 2

      - name: è½¬æ¢ QX é‡å†™è§„åˆ™
        run: |
          echo "å¼€å§‹ QX åˆ° Surge è§„åˆ™è½¬æ¢..."
          
          # ç¡®ä¿è½¬æ¢æœåŠ¡å°±ç»ª
          if ! nc -z localhost 9101; then
            echo "è½¬æ¢æœåŠ¡æœªå°±ç»ªï¼Œè·³è¿‡ QX è½¬æ¢"
            exit 0
          fi
          
          # å®šä¹‰è¦è½¬æ¢çš„ QX è§„åˆ™
          declare -A qx_rules=(
            ["MiniApp_Cleaner"]="https://github.com/fmz200/wool_scripts/raw/main/QuantumultX/rewrite/chongxie.txt"
          )
          
          # è½¬æ¢ QX è§„åˆ™
          for name in "${!qx_rules[@]}"; do
            url="${qx_rules[$name]}"
            output_file="Surge/Modules/${name}.sgmodule"
            
            echo "è½¬æ¢ QX è§„åˆ™: $name"
            encoded_name=$(echo "$name" | jq -sRr @uri)
            
            # ä½¿ç”¨ Script Hub è½¬æ¢ QX é‡å†™åˆ° Surge æ¨¡å—
            download_url="http://localhost:9101/convert/_start_/${url}/_end_/${name}.sgmodule?type=qx-rewrite&target=surge-module"
            
            # æ·»åŠ ä¸»åŠ¨é¢„é˜²å‚æ•°
            fix_script='body = body.replace(/http:\/\/127\.0\.0\.1:910[01]/g, "http://script.hub")'
            encoded_fix=$(echo "$fix_script" | jq -sRr @uri)
            download_url="${download_url}&evalScriptmodi=${encoded_fix}"
            
            if curl -A "script-hub/1.0.0" -L --connect-timeout 10 --max-time 30 -o "$output_file" "$download_url" 2>/dev/null; then
              echo "âœ… è½¬æ¢æˆåŠŸ: $name"
              
              # ä¸º MiniApp_Cleaner æ·»åŠ è§„åˆ™
              if [[ "$name" == "MiniApp_Cleaner" ]]; then
                echo "ä¸º MiniApp_Cleaner æ·»åŠ è§„åˆ™..."
                
                # æ£€æŸ¥æ˜¯å¦å·²æœ‰ [Rule] éƒ¨åˆ†
                if grep -q "^\[Rule\]" "$output_file"; then
                  # åœ¨ [Rule] éƒ¨åˆ†åæ·»åŠ è§„åˆ™
                  sed -i '/^\[Rule\]/a RULE-SET,https://ruleset.chichi.sh/Rulesets/reject/reject_fmz200.list,REJECT,pre-matching,extended-matching,no-resolve' "$output_file"
                else
                  # æ·»åŠ  [Rule] éƒ¨åˆ†å’Œè§„åˆ™
                  echo -e "\n[Rule]\nRULE-SET,https://ruleset.chichi.sh/Rulesets/reject/reject_fmz200.list,REJECT,pre-matching,extended-matching,no-resolve" >> "$output_file"
                fi
              fi
            else
              echo "âŒ è½¬æ¢å¤±è´¥: $name"
            fi
          done
          
          echo "QX è§„åˆ™è½¬æ¢å®Œæˆ"

      - name: è½¬æ¢ Loon å‚æ•°åˆ° Surge æ ¼å¼
        run: |
          echo "å¼€å§‹è½¬æ¢ Loon å‚æ•°..."
          
          # å¤„ç† Remove_ads_by_fmz çš„å‚æ•°
          if [[ -f "Surge/Modules/Remove_ads_by_fmz.sgmodule" ]]; then
            # ä»åŸå§‹ Loon æ’ä»¶æå–å‚æ•°
            loon_url="https://raw.githubusercontent.com/fmz200/wool_scripts/main/Loon/plugin/blockAds.plugin"
            
            # ä¸‹è½½åŸå§‹æ–‡ä»¶æå–å‚æ•°å’Œè„šæœ¬
            if curl -s -L "$loon_url" > /tmp/loon_plugin.txt 2>/dev/null; then
              echo "æå–åˆ° Loon æ’ä»¶ï¼Œå¼€å§‹è½¬æ¢..."
              
              # æå–å‚æ•°å¹¶è½¬æ¢æ ¼å¼
              args=""
              args_desc=""
              
              # æå–å‚æ•°éƒ¨åˆ†
              sed -n '/^\[Argument\]/,/^\[/p' /tmp/loon_plugin.txt | grep -v '^\[' > /tmp/loon_args.txt
              
              while IFS= read -r line; do
                [[ -z "$line" || "$line" =~ ^[[:space:]]*# ]] && continue
                
                # å¤„ç† switch ç±»å‹å‚æ•°
                if [[ "$line" =~ ^([a-zA-Z0-9_]+)[[:space:]]*=[[:space:]]*switch,([^,]+),([^,]+),tag=(.*)$ ]]; then
                  name="${BASH_REMATCH[1]}"
                  default="${BASH_REMATCH[2]}"
                  desc="${BASH_REMATCH[4]%%,*}"
                  args="${args}${name}:${default},"
                  args_desc="${args_desc}${name}:${desc}\\n"
                  
                # å¤„ç† select ç±»å‹å‚æ•°
                elif [[ "$line" =~ ^([a-zA-Z0-9_]+)=select,(.+),tag=([^,]+) ]]; then
                  name="${BASH_REMATCH[1]}"
                  options="${BASH_REMATCH[2]}"
                  desc="${BASH_REMATCH[3]%%,*}"
                  # è·å–ç¬¬ä¸€ä¸ªé€‰é¡¹ä½œä¸ºé»˜è®¤å€¼
                  default=$(echo "$options" | cut -d',' -f1 | tr -d '"')
                  args="${args}${name}:${default},"
                  args_desc="${args_desc}${name}:${desc}\\n"
                fi
              done < /tmp/loon_args.txt
              
              # ç§»é™¤æœ€åçš„é€—å·
              args="${args%,}"
              args_desc="${args_desc%\\n}"
              
              # åˆ›å»ºä¸´æ—¶æ–‡ä»¶
              cp "Surge/Modules/Remove_ads_by_fmz.sgmodule" "/tmp/module_temp.sgmodule"
              
              # åœ¨ç¬¬6è¡Œåæ’å…¥å‚æ•°å®šä¹‰
              sed -i '6a #!arguments='"$args" "/tmp/module_temp.sgmodule"
              sed -i '7a #!arguments-desc='"$args_desc" "/tmp/module_temp.sgmodule"
              
              # ä½¿ç”¨ sed ä¿®æ”¹è„šæœ¬æ ¼å¼
              echo "ä¿®æ”¹è„šæœ¬ä¸ºæ ‡å‡† Surge æ ¼å¼..."
              
              # åˆ›å»ºè½¬æ¢è„šæœ¬ï¼ˆä½¿ç”¨base64é¿å…YAMLè¯­æ³•å†²çªï¼‰
              echo 'IyEvYmluL2Jhc2gKIyDovazmjaLohJrmnKzlrprkuYnkuLrmoIflh4YgU3VyZ2Ug5qC85byPCgojIOWumuS5ieiEmuacrOWQjeaYoOWwhApkZWNsYXJlIC1BIHN0cmlwdF9uYW1lcz0oCiAgWyIxMjMwNl9lbmFibGUiXT0iMTIzMDYiCiAgWyI1NTVfZW5hYmxlIl09IjU1NeW9seinhiIKICBbIjUxeHlrX2VuYWJsZSJdPSI1MeS/oeeUqOWNoeeuoeWutiIKICBbImJsdWVkX2VuYWJsZSJdPSJCbHVlZCIKICBbImJkZHVkaXR1X2VuYWJsZSJdPSLnmb7luqblnLDlm74iCiAgWyJiZGR1dHBiYV9lbmFibGUiXT0i55m+5bqm6LS05ZCnIgogIFsiYmlsaWJpbGlfZW5hYmxlIl09IuWTlOWTqeWTlOWTqSIKICBbImJvaGVqbWtoX2VuYWJsZSJdPSLokYTojbflgaXlurciCiAgWyJjZHl5dG1xaV9lbmFibGUiXT0i5b2p5LqR5aSp5rCUIgogIFsiY2RubmdvZ29fZW5hYmxlIl09IuiPnOm4n+ijueijiSIKICBbImNkeGJfZW5hYmxlIl09Iui0ouaWsCIKICBbImRhdnNkbXBrX2VuYWJsZSJdPSLlpKfkvJfngrnor4QiCiAgWyJkc2h4ZmdfZW5hYmxlIl09IuWKqOeUu+eWryIKICBbImRpZGlpdXhrX2VuYWJsZSJdPSLmu7Tmu7Tlh7rooYwiCiAgWyJkZG1jX2VuYWJsZSJdPSLlj67lkrTkubDoj5wiCiAgWyJmbGlnaHRyYWRhcjI0X2VuYWJsZSJdPSJGbGlnaHRyYWRhcjI0IgogIFsiZndrZV9lbmFibGUiXT0i6aOe5a6i6Iy26aaGIgogIFsiZmZiaV9lbmFibGUiXT0i57KJ56yUIgogIFsiaGx6aF9lbmFibGUiXT0i6Iiq5peF57qq5qiqIgogIFsiaGVtYV9lbmFibGUiXT0i55uS6amiIgogIFsiaGZ0eF9lbmFibGUiXT0i5rGH5LuY5aSp5LiLIgogIFsiaXR6al9lbmFibGUiXT0iSVTkuYvlrrYiCiAgWyJqaHNoX2VuYWJsZSJdPSLlu7rooYznlJ/mtLsiCiAgWyJqa2RzX2VuYWJsZSJdPSLkuqzkuJwiCiAgWyJqa3hpX2VuYWJsZSJdPSLkuqzllpwiCiAgWyJrZWVwX2VuYWJsZSJdPSJrZWVwIgogIFsia2t1el9lbmFibGUiXT0i5b+r5omLIgogIFsia3hrZV9lbmFibGUiXT0i5aSu5YWLIgogIFsia3V3b3lidHlfZW5hYmxlIl09IumFt+aIkemfs+S5kCIKICBbImt1YW5fZW5hYmxlIl09IumFt+WuiSIKKQoKZmlsZT0iJDEiCgojIOaJvuWIsOS/ruaUueeahOadoeS7tgp3aGlsZSBJRlM9IHJlYWQgLXIgbGluZTsgZG8KICBpZiBbWyAiJGxpbmUiID1+IF5ce3t7KFteXV0rKVx9XH1cID1cICguKykkIF1dOyB0aGVuCiAgICBwYXJhbV9uYW1lPSIke0JBU0hfUkVNQVRDSFsxXX0iCiAgICBzY3JpcHRfZGVmPSIke0JBU0hfUkVNQVRDSFsyXX0iCiAgICAKICAgICMg6I635Y+W6ISa5pys5ZCNCiAgICBzY3JpcHRfbmFtZT0iJHtzY3JpcHRfbmFtZXNbJHBhcmFtX25hbWVdfSIKICAgIGlmIFtbIC16ICIkc2NyaXB0X25hbWUiIF1dOyB0aGVuCiAgICAgIHNjcmlwdF9uYW1lPSIke3BhcmFtX25hbWUlX2VuYWJsZX0iCiAgICBmaQogICAgCiAgICAjIOa3u+WKoCBhcmd1bWVudCDlj4LmlbAKICAgIGlmIFtbICEgIiRzY3JpcHRfZGVmIiA9fiBhcmd1bWVudD0gXV07IHRoZW4KICAgICAgaWYgW1sgIiRzY3JpcHRfZGVmIiA9fiAoLiopKCxcIHRpbWVvdXQ9WzAtOV0rKSguKikgXV07IHRoZW4KICAgICAgICBzY3JpcHRfZGVmPSIke0JBU0hfUkVNQVRDSFsxXX0ke0JBU0hfUkVNQVRDSFsyXX0sIGFyZ3VtZW50PWVuYWJsZT1cJHskcGFyYW1fbmFtZX0ke0JBU0hfUkVNQVRDSFszXX0iCiAgICAgIGVsaWYgW1sgIiRzY3JpcHRfZGVmIiA9fiAoLiopKCxcIHJlcXVpcmVzLWJvZHk9W2Etel0rKSguKikgXV07IHRoZW4KICAgICAgICBzY3JpcHRfZGVmPSIke0JBU0hfUkVNQVRDSFsxXX0ke0JBU0hfUkVNQVRDSFsyXX0sIGFyZ3VtZW50PWVuYWJsZT1cJHskcGFyYW1fbmFtZX0ke0JBU0hfUkVNQVRDSFszXX0iCiAgICAgIGVsc2UKICAgICAgICBzY3JpcHRfZGVmPSQoZWNobyAiJHNjcmlwdF9kZWYiIHwgc2VkIC1FICJzfChzY3JpcHQtcGF0aD1bXixdKyl8XDEsIGFyZ3VtZW50PWVuYWJsZT1cJHskcGFyYW1fbmFtZX18IikKICAgICAgZmkKICAgIGZpCiAgICAKICAgIGVjaG8gIiRzY3JpcHRfbmFtZSA9ICRzY3JpcHRfZGVmIgogIGVsc2UKICAgIGVjaG8gIiRsaW5lIgogIGZpCmRvbmUgPCAiJGZpbGUiID4gIiR7ZmlsZX0udG1wIgoKbXYgIiR7ZmlsZX0udG1wIiAiJGZpbGUi' | base64 -d > /tmp/convert_scripts.sh
              
              # æ‰§è¡Œè½¬æ¢è„šæœ¬
              chmod +x /tmp/convert_scripts.sh
              /tmp/convert_scripts.sh "/tmp/module_temp.sgmodule"
              
              # æ›¿æ¢åŸæ–‡ä»¶
              mv "/tmp/module_temp.sgmodule" "Surge/Modules/Remove_ads_by_fmz.sgmodule"
              
              # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
              rm -f /tmp/loon_plugin.txt /tmp/loon_args.txt /tmp/convert_scripts.sh
              
              echo "âœ… Remove_ads_by_fmz å‚æ•°è½¬æ¢å®Œæˆ"
              
              # éªŒè¯å‚æ•°æ˜¯å¦æ­£ç¡®æ·»åŠ 
              if grep -q "^#!arguments=" "Surge/Modules/Remove_ads_by_fmz.sgmodule"; then
                echo "å‚æ•°å®šä¹‰å·²æˆåŠŸæ·»åŠ "
                echo "æ˜¾ç¤ºå‰30è¡Œå†…å®¹ï¼š"
                head -30 "Surge/Modules/Remove_ads_by_fmz.sgmodule"
                
                # æ˜¾ç¤ºä¸€äº›è½¬æ¢åçš„è„šæœ¬ç¤ºä¾‹
                echo -e "\nè½¬æ¢åçš„è„šæœ¬ç¤ºä¾‹ï¼š"
                grep -E "^[^{].*= type=http-.*, argument=" "Surge/Modules/Remove_ads_by_fmz.sgmodule" | head -5
              fi
            fi
          fi
          
          echo "å‚æ•°è½¬æ¢å®Œæˆ"

      - name: åˆå¹¶ Surge æ¨¡å—
        run: |
          echo "å¼€å§‹åˆå¹¶ Surge æ¨¡å—..."
          mkdir -p Surge/Modules/Rules
          npm run merge

      - name: éªŒè¯è§„åˆ™å®Œæ•´æ€§
        id: validate
        run: |
          echo "å¼€å§‹è§„åˆ™éªŒè¯..."
          mkdir -p .cache
          
          echo "éªŒè¯è§„åˆ™è¯­æ³•..."
          NODE_OPTIONS="--experimental-specifier-resolution=node" tsx Chores/engineering/build/scripts/validate-rule-syntax.ts || true
          
          echo "éªŒè¯éæ³• TLD..."
          NODE_OPTIONS="--experimental-specifier-resolution=node" tsx Chores/engineering/build/scripts/validate-illegal-tld.ts || true
          
          echo "æ£€æµ‹å“ˆå¸Œå†²çª..."
          NODE_OPTIONS="--experimental-specifier-resolution=node" tsx Chores/engineering/build/scripts/validate-hash-collision.ts || true
          
          syntax_errors=0
          tld_errors=0
          hash_errors=0
          
          [ -f ".cache/syntax-errors.json" ] && syntax_errors=$(jq '.errors | length' .cache/syntax-errors.json 2>/dev/null || echo "0")
          [ -f ".cache/illegal-tlds.json" ] && tld_errors=$(jq length .cache/illegal-tlds.json 2>/dev/null || echo "0")
          [ -f ".cache/hash-collisions.json" ] && hash_errors=$(jq length .cache/hash-collisions.json 2>/dev/null || echo "0")
          
          total_errors=$((syntax_errors + tld_errors + hash_errors))
          
          echo "validation_errors_count=$total_errors" >> $GITHUB_OUTPUT
          echo "syntax_errors=$syntax_errors" >> $GITHUB_OUTPUT
          echo "tld_errors=$tld_errors" >> $GITHUB_OUTPUT
          echo "hash_errors=$hash_errors" >> $GITHUB_OUTPUT
          
          if [ "$total_errors" -gt 0 ]; then
            echo "has_validation_errors=true" >> $GITHUB_OUTPUT
            echo "å‘ç° $total_errors ä¸ªéªŒè¯é”™è¯¯"
            echo "  - è¯­æ³•é”™è¯¯: $syntax_errors"
            echo "  - TLD é”™è¯¯: $tld_errors"
            echo "  - å“ˆå¸Œå†²çª: $hash_errors"
            exit 1
          else
            echo "has_validation_errors=false" >> $GITHUB_OUTPUT
            echo "æ‰€æœ‰è§„åˆ™éªŒè¯é€šè¿‡"
          fi

      - name: æäº¤æ›´æ”¹
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add Surge/Modules/*.sgmodule 2>/dev/null || true
          git add Surge/Modules/Rules/*.list 2>/dev/null || true
          git add Surge/Scripts/*.js 2>/dev/null || true
          git add Surge/Rulesets/**/*.list 2>/dev/null || true
          git add Chores/ruleset/**/*.list 2>/dev/null || true
          
          if git diff --cached --quiet; then
            echo "æ²¡æœ‰æ–‡ä»¶éœ€è¦æäº¤"
          else
            sgmodule_count=$(find Surge/Modules -name "*.sgmodule" 2>/dev/null | wc -l || echo "0")
            ruleset_count=$(find Surge/Rulesets -name "*.list" 2>/dev/null | wc -l || echo "0")
            
            git commit -m "è‡ªåŠ¨æ„å»ºæ›´æ–° - $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S') [æ¨¡å—${sgmodule_count}ä¸ª] [è§„åˆ™${ruleset_count}ä¸ª] [è§¦å‘${{ github.event_name }}]"
            
            max_retries=3
            retry_count=0
            while [ $retry_count -lt $max_retries ]; do
              if git push; then
                echo "æ¨é€æˆåŠŸ"
                break
              else
                echo "æ¨é€å¤±è´¥ï¼Œå°è¯•åŒæ­¥è¿œç¨‹æ›´æ”¹... (å°è¯• $((retry_count + 1))/$max_retries)"
                git pull --rebase || {
                  echo "Rebase å¤±è´¥ï¼Œä½¿ç”¨ merge ç­–ç•¥"
                  git pull --no-rebase
                }
                retry_count=$((retry_count + 1))
                if [ $retry_count -eq $max_retries ]; then
                  echo "è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œæ¨é€å¤±è´¥"
                  exit 1
                fi
              fi
            done
          fi

      - name: ä¿å­˜ç¼“å­˜
        if: always()
        uses: actions/cache/save@v4
        with:
          path: |
            .cache
            .cache/*.db
            .cache/*.db-wal
            .cache/*.db-shm
          key: ${{ runner.os }}-build-cache-v4-${{ steps.date.outputs.year }}-${{ steps.date.outputs.month }}-${{ steps.date.outputs.day }} ${{ steps.date.outputs.hour }}:${{ steps.date.outputs.minute }}:${{ steps.date.outputs.second }}

      - name: ç”Ÿæˆæ„å»ºæŠ¥å‘Š
        if: always()
        run: |
          echo "## ä¸»æ„å»ºæµç¨‹æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### æ„å»ºç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
          echo "- æ‰§è¡Œæ—¶é—´: ${{ steps.date.outputs.date }}" >> $GITHUB_STEP_SUMMARY
          echo "- è§¦å‘æ–¹å¼: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- ç¼“å­˜çŠ¶æ€: ${{ steps.cache-restore.outputs.cache-hit == 'true' && 'å‘½ä¸­' || 'æœªå‘½ä¸­' }}" >> $GITHUB_STEP_SUMMARY
          
          sgmodule_count=$(find Surge/Modules -name "*.sgmodule" 2>/dev/null | wc -l || echo "0")
          ruleset_count=$(find Surge/Rulesets -name "*.list" 2>/dev/null | wc -l || echo "0")
          echo "- è½¬æ¢æ¨¡å—: $sgmodule_count ä¸ª" >> $GITHUB_STEP_SUMMARY
          echo "- è§„åˆ™æ–‡ä»¶: $ruleset_count ä¸ª" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### éªŒè¯ç»“æœ" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.validate.outputs.has_validation_errors }}" == "true" ]; then
            echo "- çŠ¶æ€: å‘ç°é—®é¢˜" >> $GITHUB_STEP_SUMMARY
            echo "- è¯­æ³•é”™è¯¯: ${{ steps.validate.outputs.syntax_errors }} ä¸ª" >> $GITHUB_STEP_SUMMARY
            echo "- TLD é”™è¯¯: ${{ steps.validate.outputs.tld_errors }} ä¸ª" >> $GITHUB_STEP_SUMMARY
            echo "- å“ˆå¸Œå†²çª: ${{ steps.validate.outputs.hash_errors }} ä¸ª" >> $GITHUB_STEP_SUMMARY
          else
            echo "- çŠ¶æ€: éªŒè¯é€šè¿‡" >> $GITHUB_STEP_SUMMARY
            echo "- æ€»é”™è¯¯æ•°: 0 ä¸ª" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "æç¤º: åŸŸåæ´»æ€§æ£€æµ‹éœ€æ‰‹åŠ¨è§¦å‘ check-domain.yml å·¥ä½œæµ" >> $GITHUB_STEP_SUMMARY

  deploy:
    needs: main_build
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    name: éƒ¨ç½²
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: åˆ›å»º RAM ç£ç›˜æ„å»ºç›®å½•
        id: build_dir
        run: |
          # åˆ›å»ºRAMç£ç›˜ç›®å½•
          RAM_DIR="/dev/shm/esdeath_build"
          sudo mkdir -p $RAM_DIR
          sudo chmod 777 $RAM_DIR
          echo "ä¸´æ—¶æ„å»ºç›®å½•: $RAM_DIR"
          echo "dir=$RAM_DIR" >> $GITHUB_OUTPUT

      - name: æ„å»ºç½‘ç«™
        run: |
          echo "å¼€å§‹æ„å»ºç½‘ç«™..."
          
          # è®¾ç½®ç¯å¢ƒå˜é‡æŒ‡å®š RAM ç£ç›˜ä¸ºè¾“å‡ºç›®å½•
          export OUTPUT_DIR="${{ steps.build_dir.outputs.dir }}"
          export RAM_DIR="${{ steps.build_dir.outputs.dir }}"
          export CI=true
          
          # æ‰§è¡Œæ„å»ºå‘½ä»¤
          npm run build
          
          # éªŒè¯æ„å»ºç»“æœ
          if [ ! -d "$OUTPUT_DIR" ] || [ -z "$(ls -A $OUTPUT_DIR)" ]; then
            echo "âŒ æ„å»ºå¤±è´¥ï¼šè¾“å‡ºç›®å½•ä¸ºç©º"
            exit 1
          fi
          
          # å¦‚æœæ„å»ºè¾“å‡ºåˆ°äº† public ç›®å½•è€Œä¸æ˜¯ RAM ç£ç›˜ï¼Œåˆ™å¤åˆ¶è¿‡å»
          if [ -d "public" ] && [ "$OUTPUT_DIR" != "$(pwd)/public" ]; then
            echo "å¤åˆ¶æ„å»ºç»“æœåˆ° RAM ç£ç›˜..."
            cp -r public/* "$OUTPUT_DIR/" || true
          fi
          
          # ç¡®ä¿æœ‰ index.html
          if [ ! -f "$OUTPUT_DIR/index.html" ]; then
            echo "âŒ æ„å»ºå¤±è´¥ï¼šç¼ºå°‘ index.html"
            exit 1
          fi
          
          # è¾“å‡ºæ„å»ºç»Ÿè®¡
          echo "âœ… ç½‘ç«™æ„å»ºæˆåŠŸï¼"
          echo "ğŸ“Š æ„å»ºç»Ÿè®¡ï¼š"
          echo "  - è§„åˆ™æ–‡ä»¶: $(find $OUTPUT_DIR/Rulesets -name "*.list" 2>/dev/null | wc -l || echo "0") ä¸ª"
          echo "  - æ¨¡å—æ–‡ä»¶: $(find $OUTPUT_DIR/Modules -name "*.sgmodule" 2>/dev/null | wc -l || echo "0") ä¸ª"
          echo "  - è„šæœ¬æ–‡ä»¶: $(find $OUTPUT_DIR/Scripts -name "*.js" 2>/dev/null | wc -l || echo "0") ä¸ª"
          echo "  - æ€»å¤§å°: $(du -sh $OUTPUT_DIR | cut -f1)"
          
          # ç”Ÿæˆéƒ¨ç½²ä¿¡æ¯
          echo "éƒ¨ç½²æ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')" > $OUTPUT_DIR/deploy-info.txt
          echo "Git Commit: ${{ github.sha }}" >> $OUTPUT_DIR/deploy-info.txt
          echo "æ„å»ºç›®å½•: $OUTPUT_DIR" >> $OUTPUT_DIR/deploy-info.txt
        env:
          TZ: 'Asia/Shanghai'
          CI: 'true'

      - name: æ„å»ºåæ£€æŸ¥
        run: |
          OUTPUT_DIR="${{ steps.build_dir.outputs.dir }}"
          
          if [ ! -d "$OUTPUT_DIR" ]; then
            echo "âŒ æ„å»ºç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          
          if [ ! -f "$OUTPUT_DIR/index.html" ]; then
            echo "âŒ index.html ä¸å­˜åœ¨"
            exit 1
          fi
          
          if [ -z "$(ls -A $OUTPUT_DIR)" ]; then
            echo "âŒ æ„å»ºç›®å½•ä¸ºç©º"
            exit 1
          fi
          
          echo "âœ… æ„å»ºæ£€æŸ¥é€šè¿‡"
          echo "ğŸ“ æ„å»ºç›®å½•å†…å®¹ï¼š"
          ls -la $OUTPUT_DIR
          
          # æ˜¾ç¤º index.html çš„å‰å‡ è¡Œç¡®è®¤æ˜¯æ­£ç¡®çš„ç½‘ç«™
          echo ""
          echo "ğŸ“„ index.html é¢„è§ˆï¼š"
          head -n 20 $OUTPUT_DIR/index.html || true

      - name: è®¾ç½® GitHub Pages
        uses: actions/configure-pages@v5

      - name: ä¸Šä¼ éƒ¨ç½²æ–‡ä»¶
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ steps.build_dir.outputs.dir }}

      - name: éƒ¨ç½²åˆ° GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        
      - name: éƒ¨ç½²æˆåŠŸé€šçŸ¥
        if: success()
        run: |
          echo "âœ… éƒ¨ç½²æˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
          echo "ğŸŒ è®¿é—®åœ°å€: ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“… éƒ¨ç½²æ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“¦ Git Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
