name: Auto Rules Validation (Syntax Only)

on:
  workflow_dispatch:
  schedule:
    # æ¯æ—¥å‡Œæ™¨2ç‚¹è‡ªåŠ¨æ£€æŸ¥
    - cron: "0 2 * * *"

# é¿å…é‡å¤è¿è¡Œ
concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  validate-syntax:
    name: éªŒè¯è§„åˆ™è¯­æ³•
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            Surge
            Dial
            Chores
            Source
          sparse-checkout-cone-mode: false

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: å®‰è£…ä¾èµ–
        run: |
          cd Chores/engineering
          npm ci --prefer-offline --no-audit
          
      - name: è¿è¡Œè¯­æ³•éªŒè¯
        id: validate
        run: |
          cd Chores/engineering
          echo "å¼€å§‹æ¯æ—¥è§„åˆ™è¯­æ³•éªŒè¯..."
          mkdir -p .cache
          
          # è¯­æ³•éªŒè¯
          echo "éªŒè¯è§„åˆ™è¯­æ³•..."
          NODE_OPTIONS="--experimental-specifier-resolution=node" tsx build/scripts/validate-rule-syntax.ts || true
          
          # éªŒè¯éžæ³• TLD
          echo "éªŒè¯éžæ³• TLD..."
          NODE_OPTIONS="--experimental-specifier-resolution=node" tsx build/scripts/validate-illegal-tld.ts || true
          
          # æ£€æµ‹å“ˆå¸Œå†²çª
          echo "æ£€æµ‹å“ˆå¸Œå†²çª..."
          NODE_OPTIONS="--experimental-specifier-resolution=node" tsx build/scripts/detect-hash-collisions.ts || true
          
          # æ”¶é›†é”™è¯¯ç»Ÿè®¡
          syntax_errors=$([ -f ".cache/syntax-errors.json" ] && jq length .cache/syntax-errors.json 2>/dev/null || echo "0")
          tld_errors=$([ -f ".cache/illegal-tld-errors.json" ] && jq length .cache/illegal-tld-errors.json 2>/dev/null || echo "0")
          hash_errors=$([ -f ".cache/hash-collisions.json" ] && jq length .cache/hash-collisions.json 2>/dev/null || echo "0")
          
          total_errors=$((syntax_errors + tld_errors + hash_errors))
          
          # ç”ŸæˆæŠ¥å‘Š
          echo "## ðŸ“Š æ¯æ—¥è¯­æ³•éªŒè¯æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **è¿è¡Œæ—¶é—´**: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "- **è¯­æ³•é”™è¯¯**: $syntax_errors ä¸ª" >> $GITHUB_STEP_SUMMARY
          echo "- **éžæ³•TLD**: $tld_errors ä¸ª" >> $GITHUB_STEP_SUMMARY
          echo "- **å“ˆå¸Œå†²çª**: $hash_errors ä¸ª" >> $GITHUB_STEP_SUMMARY
          echo "- **æ€»é”™è¯¯æ•°**: $total_errors ä¸ª" >> $GITHUB_STEP_SUMMARY
          
          if [ "$total_errors" -gt "0" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ å‘çŽ° $total_errors ä¸ªé”™è¯¯ï¼Œè¯·æ£€æŸ¥æ—¥å¿—èŽ·å–è¯¦ç»†ä¿¡æ¯ã€‚" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… æ‰€æœ‰è§„åˆ™éªŒè¯é€šè¿‡ï¼" >> $GITHUB_STEP_SUMMARY
          fi
          
      - name: ä¸Šä¼ é”™è¯¯æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-errors-${{ github.run_id }}
          path: |
            Chores/engineering/.cache/*-errors.json
            Chores/engineering/.cache/hash-collisions.json
          retention-days: 7
          if-no-files-found: ignore
