name: Auto Rules Validation (Syntax Only)

on:
  # è‡ªåŠ¨è§¦å‘ï¼šå®ŒæˆåŒæ­¥è§„åˆ™ã€åˆå¹¶è§„åˆ™å
  push:
    branches:
      - main
      - master
    paths:
      - 'Surge/Rulesets/**'
      - 'Chores/ruleset/**'
  pull_request:
    paths:
      - 'Surge/Rulesets/**'
      - 'Chores/ruleset/**'
  schedule:
    # æ¯æ—¥å‡Œæ™¨2ç‚¹è‡ªåŠ¨æ£€æŸ¥
    - cron: "0 2 * * *"

# é¿å…é‡å¤è¿è¡Œ
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  validate-syntax:
    name: ğŸ” è§„åˆ™è¯­æ³•éªŒè¯
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          persist-credentials: false
      
      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: å®‰è£…ä¾èµ–
        run: npm ci
      
      # å¿«é€Ÿè¯­æ³•éªŒè¯ï¼ˆä¸åŒ…å«åŸŸåæµ‹æ´»ï¼‰
      - name: ğŸ“ éªŒè¯è§„åˆ™è¯­æ³•
        id: syntax-check
        run: |
          mkdir -p .cache
          echo "ğŸ” å¼€å§‹è§„åˆ™è¯­æ³•éªŒè¯..."
          NODE_OPTIONS="--experimental-specifier-resolution=node" tsx Chores/engineering/build/scripts/validate-rule-syntax.ts
          
          # æ£€æŸ¥è¯­æ³•é”™è¯¯æ•°é‡
          if [ -f ".cache/syntax-errors.json" ]; then
            ERROR_COUNT=$(jq '.errors | length' .cache/syntax-errors.json 2>/dev/null || echo "0")
            echo "syntax_errors_count=$ERROR_COUNT" >> $GITHUB_OUTPUT
            if [ "$ERROR_COUNT" -gt 0 ]; then
              echo "has_syntax_errors=true" >> $GITHUB_OUTPUT
              echo "âŒ å‘ç° $ERROR_COUNT ä¸ªè¯­æ³•é”™è¯¯"
              exit 1
            else
              echo "has_syntax_errors=false" >> $GITHUB_OUTPUT
              echo "âœ… æ‰€æœ‰è§„åˆ™è¯­æ³•æ­£ç¡®"
            fi
          else
            echo "has_syntax_errors=false" >> $GITHUB_OUTPUT
            echo "âœ… è§„åˆ™è¯­æ³•éªŒè¯å®Œæˆ"
          fi
      
      - name: ğŸŒ éªŒè¯éæ³•TLD
        id: tld-check
        run: |
          echo "ğŸŒ å¼€å§‹TLDéªŒè¯..."
          NODE_OPTIONS="--experimental-specifier-resolution=node" tsx Chores/engineering/build/scripts/validate-illegal-tld.ts
          
          if [ -f ".cache/illegal-tlds.json" ]; then
            TLD_COUNT=$(jq length .cache/illegal-tlds.json)
            if [ "$TLD_COUNT" -gt 0 ]; then
              echo "âŒ å‘ç° $TLD_COUNT ä¸ªéæ³•TLD"
              exit 1
            else
              echo "âœ… æ‰€æœ‰TLDåˆæ³•"
            fi
          fi
      
      - name: ğŸ”— éªŒè¯å“ˆå¸Œå†²çª
        id: hash-check
        run: |
          echo "ğŸ”— å¼€å§‹å“ˆå¸Œå†²çªæ£€æµ‹..."
          NODE_OPTIONS="--experimental-specifier-resolution=node" tsx Chores/engineering/build/scripts/validate-hash-collision.ts
          
          if [ -f ".cache/hash-collisions.json" ]; then
            HASH_COUNT=$(jq length .cache/hash-collisions.json)
            if [ "$HASH_COUNT" -gt 0 ]; then
              echo "âŒ å‘ç° $HASH_COUNT ä¸ªå“ˆå¸Œå†²çª"
              exit 1
            else
              echo "âœ… æ— å“ˆå¸Œå†²çª"
            fi
          fi
      
      # éªŒè¯æˆåŠŸåçš„åç»­æ“ä½œ
      - name: âœ… è§„åˆ™éªŒè¯é€šè¿‡
        run: |
          echo "ğŸ‰ æ‰€æœ‰è§„åˆ™éªŒè¯é€šè¿‡ï¼Œå¯ä»¥ç»§ç»­æ„å»ºæµç¨‹"
          echo "## âœ… è§„åˆ™éªŒè¯ç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "- **è§„åˆ™è¯­æ³•**: é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          echo "- **TLDéªŒè¯**: é€šè¿‡" >> $GITHUB_STEP_SUMMARY  
          echo "- **å“ˆå¸Œå†²çª**: æ— å†²çª" >> $GITHUB_STEP_SUMMARY
          echo "- **éªŒè¯æ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY

  # è§„åˆ™éªŒè¯é€šè¿‡åï¼Œè§¦å‘æ„å»ºæµç¨‹
  trigger-build:
    name: ğŸš€ è§¦å‘æ„å»º
    needs: validate-syntax
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    
    steps:
      - name: è§¦å‘ç½‘ç«™æ„å»º
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // è§¦å‘ build.yml å·¥ä½œæµ
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build.yml',
              ref: 'main'
            });
            
            console.log('âœ… å·²è§¦å‘ç½‘ç«™æ„å»ºå·¥ä½œæµ');
