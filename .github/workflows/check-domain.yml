name: Manual Domain Alive Check
on:
  # ä»…æ‰‹åŠ¨è§¦å‘ - åŸŸåæµ‹æ´»èµ„æºæ¶ˆè€—å¤§ï¼Œé¿å…è‡ªåŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      auto_fix:
        description: 'æ˜¯å¦è‡ªåŠ¨ä¿®å¤å‘çŽ°çš„é—®é¢˜ (åˆ é™¤å¤±æ•ˆåŸŸå)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      concurrency_level:
        description: 'å¹¶å‘æ•°é‡ (æŽ¨è: 32-64ï¼Œè¿‡é«˜å¯èƒ½è¢«DNSæœåŠ¡å™¨é™åˆ¶)'
        required: false
        default: '64'
        type: choice
        options:
          - '32'
          - '64'
          - '96'
          - '128'

jobs:
  domain-alive-check:
    name: ðŸ” åŸŸåæ´»æ€§æ£€æµ‹
    # ä½¿ç”¨ARM runneré™ä½Žæˆæœ¬ï¼ˆå‚è€ƒSurgeç­–ç•¥ï¼‰
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 180  # 3å°æ—¶è¶…æ—¶ä¿æŠ¤

    steps:
      - name: èŽ·å–å½“å‰æ—¥æœŸ
        id: date
        run: |
          echo "date=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT
          echo "year=$(date +'%Y')" >> $GITHUB_OUTPUT
          echo "month=$(date +'%m')" >> $GITHUB_OUTPUT
          echo "day=$(date +'%d')" >> $GITHUB_OUTPUT
          echo "hour=$(date +'%H')" >> $GITHUB_OUTPUT
          echo "minute=$(date +'%M')" >> $GITHUB_OUTPUT
          echo "second=$(date +'%S')" >> $GITHUB_OUTPUT
      
      - name: ðŸ—„ï¸ æ¢å¤åŸŸåç¼“å­˜ (Surgeçº§ç­–ç•¥)
        uses: actions/cache/restore@v4
        id: cache-restore
        with:
          path: |
            .cache
            .cache/undici-better-sqlite3-cache-store.db
            .cache/dns-cache.db
            .cache/doh-cache.db
          # åˆ†é’Ÿçº§ç²¾ç¡®ç¼“å­˜é”® - æœ€å¤§åŒ–ç¼“å­˜å‘½ä¸­çŽ‡
          key: ${{ runner.os }}-domain-cache-v3-${{ steps.date.outputs.year }}-${{ steps.date.outputs.month }}-${{ steps.date.outputs.day }} ${{ steps.date.outputs.hour }}:${{ steps.date.outputs.minute }}:${{ steps.date.outputs.second }}
          # å¤šçº§å›žé€€ç­–ç•¥ - å‚è€ƒSurgeå®žçŽ°
          restore-keys: |
            ${{ runner.os }}-domain-cache-v3-${{ steps.date.outputs.year }}-${{ steps.date.outputs.month }}-${{ steps.date.outputs.day }} ${{ steps.date.outputs.hour }}:${{ steps.date.outputs.minute }}:
            ${{ runner.os }}-domain-cache-v3-${{ steps.date.outputs.year }}-${{ steps.date.outputs.month }}-${{ steps.date.outputs.day }} ${{ steps.date.outputs.hour }}:
            ${{ runner.os }}-domain-cache-v3-${{ steps.date.outputs.year }}-${{ steps.date.outputs.month }}-${{ steps.date.outputs.day }}
            ${{ runner.os }}-domain-cache-v3-${{ steps.date.outputs.year }}-${{ steps.date.outputs.month }}-
            ${{ runner.os }}-domain-cache-v3-${{ steps.date.outputs.year }}-
            ${{ runner.os }}-domain-cache-v3-
      
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          persist-credentials: ${{ github.event.inputs.auto_fix == 'true' }}
          token: ${{ github.event.inputs.auto_fix == 'true' && secrets.GITHUB_TOKEN || '' }}
      
      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: å®‰è£…ä¾èµ–
        run: npm ci
      
      # æ ¸å¿ƒåŸŸåæ´»æ€§æ£€æµ‹ - é«˜å¹¶å‘ä¼˜åŒ–
      - name: ðŸš€ åŸŸåæ´»æ€§æ£€æµ‹ (å¹¶å‘=${{ github.event.inputs.concurrency_level }})
        id: domain-check
        env:
          CONCURRENCY: ${{ github.event.inputs.concurrency_level }}
        run: |
          mkdir -p .cache
          echo "ðŸ” å¼€å§‹é«˜å¹¶å‘åŸŸåæ´»æ€§æ£€æµ‹..."
          echo "âš™ï¸ å¹¶å‘æ•°é‡: ${{ github.event.inputs.concurrency_level }}"
          echo "ðŸ“Š ç¼“å­˜çŠ¶æ€: ${{ steps.cache-restore.outputs.cache-hit == 'true' && 'å‘½ä¸­' || 'æœªå‘½ä¸­' }}"
          
          # ä¼ é€’å¹¶å‘æ•°é‡ç»™è„šæœ¬
          export CONCURRENCY=${{ github.event.inputs.concurrency_level }}
          
          if [ "${{ github.event.inputs.auto_fix }}" == "true" ]; then
            NODE_OPTIONS="--experimental-specifier-resolution=node" tsx Chores/engineering/build/scripts/clean-dead-domains.ts --fix
            echo "auto_fix_executed=true" >> $GITHUB_OUTPUT
          else
            NODE_OPTIONS="--experimental-specifier-resolution=node" tsx Chores/engineering/build/scripts/clean-dead-domains.ts
          fi
          
          # ç»Ÿè®¡æ£€æµ‹ç»“æžœ
          if [ -f ".cache/dead-domains.json" ]; then
            DEAD_COUNT=$(jq length .cache/dead-domains.json)
            echo "dead_domains_count=$DEAD_COUNT" >> $GITHUB_OUTPUT
            if [ "$DEAD_COUNT" -gt 0 ]; then
              echo "has_dead_domains=true" >> $GITHUB_OUTPUT
              echo "ðŸ”´ å‘çŽ° $DEAD_COUNT ä¸ªå¤±æ•ˆåŸŸå"
            else
              echo "has_dead_domains=false" >> $GITHUB_OUTPUT
              echo "ðŸŸ¢ æ‰€æœ‰åŸŸåå­˜æ´»æ­£å¸¸"
            fi
          else
            echo "has_dead_domains=false" >> $GITHUB_OUTPUT
          fi
      
      # è‡ªåŠ¨ä¿®å¤åŠŸèƒ½
      - name: ðŸ”§ è‡ªåŠ¨ä¿®å¤å¤±æ•ˆåŸŸå
        if: github.event.inputs.auto_fix == 'true' && steps.domain-check.outputs.auto_fix_executed == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          if git diff --quiet; then
            echo "ðŸ’¡ æ²¡æœ‰æ–‡ä»¶è¢«ä¿®æ”¹ï¼Œè·³è¿‡æäº¤"
          else
            git add .
            git commit -m "ðŸ¤– è‡ªåŠ¨ä¿®å¤: ç§»é™¤å¤±æ•ˆåŸŸå [skip ci]
            
            - ç§»é™¤ ${{ steps.domain-check.outputs.dead_domains_count }} ä¸ªå¤±æ•ˆåŸŸå
            - å¹¶å‘æ•°é‡: ${{ github.event.inputs.concurrency_level }}
            - ä¿®å¤æ—¶é—´: ${{ steps.date.outputs.date }}
            - è§¦å‘è€…: @${{ github.actor }}"
            
            git push
            echo "âœ… è‡ªåŠ¨ä¿®å¤å·²æäº¤"
          fi
      
      # ä¿å­˜å¢žå¼ºç¼“å­˜
      - name: ðŸ’¾ ä¿å­˜åŸŸåç¼“å­˜ (æŒä¹…åŒ–DNSæŸ¥è¯¢ç»“æžœ)
        if: always()
        uses: actions/cache/save@v4
        with:
          path: |
            .cache
            .cache/undici-better-sqlite3-cache-store.db
            .cache/dns-cache.db
            .cache/doh-cache.db
          key: ${{ runner.os }}-domain-cache-v3-${{ steps.date.outputs.year }}-${{ steps.date.outputs.month }}-${{ steps.date.outputs.day }} ${{ steps.date.outputs.hour }}:${{ steps.date.outputs.minute }}:${{ steps.date.outputs.second }}
      
      # è¯¦ç»†æ€§èƒ½æŠ¥å‘Š
      - name: ðŸ“Š æ€§èƒ½ä¸Žç»“æžœæ±‡æ€»
        run: |
          echo "## ðŸ” åŸŸåæ´»æ€§æ£€æµ‹æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ€§èƒ½æŒ‡æ ‡
          echo "### âš¡ æ€§èƒ½æŒ‡æ ‡" >> $GITHUB_STEP_SUMMARY
          echo "- **å¹¶å‘æ•°é‡**: ${{ github.event.inputs.concurrency_level }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ç¼“å­˜çŠ¶æ€**: ${{ steps.cache-restore.outputs.cache-hit == 'true' && 'âœ… å‘½ä¸­ (å¤§å¹…åŠ é€Ÿ)' || 'âŒ æœªå‘½ä¸­ (é¦–æ¬¡è¿è¡Œ)' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ‰§è¡Œæ—¶é—´**: å¼€å§‹äºŽ ${{ steps.date.outputs.date }}" >> $GITHUB_STEP_SUMMARY
          
          # æ£€æµ‹ç»“æžœ
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ æ£€æµ‹ç»“æžœ" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.domain-check.outputs.has_dead_domains }}" == "true" ]; then
            echo "- **çŠ¶æ€**: âŒ å‘çŽ°é—®é¢˜" >> $GITHUB_STEP_SUMMARY
            echo "- **å¤±æ•ˆåŸŸå**: ${{ steps.domain-check.outputs.dead_domains_count }} ä¸ª" >> $GITHUB_STEP_SUMMARY
            if [ "${{ github.event.inputs.auto_fix }}" == "true" ]; then
              echo "- **ä¿®å¤çŠ¶æ€**: âœ… å·²è‡ªåŠ¨ä¿®å¤å¹¶æäº¤" >> $GITHUB_STEP_SUMMARY
            else
              echo "- **ä¿®å¤å»ºè®®**: ðŸ’¡ ä½¿ç”¨ \`auto_fix=true\` è‡ªåŠ¨ä¿®å¤" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- **çŠ¶æ€**: âœ… æ‰€æœ‰åŸŸåå­˜æ´»æ­£å¸¸" >> $GITHUB_STEP_SUMMARY
            echo "- **å¤±æ•ˆåŸŸå**: 0 ä¸ª" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¡ **ä¼˜åŒ–å»ºè®®**: å®šæœŸè¿è¡Œå¯ç»´æŠ¤ç¼“å­˜ï¼Œæå‡åŽç»­æ£€æµ‹é€Ÿåº¦" >> $GITHUB_STEP_SUMMARY
